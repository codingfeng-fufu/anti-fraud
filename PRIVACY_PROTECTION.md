# 🔒 隐私保护方案 - 本地存储（已更新）

## 🎯 设计理念

**核心原则：** 用户隐私至上，对话内容**仅保存在用户手机本地**，不上传服务器，用户完全控制。

## ⚡ 重要更新

**最新方案：本地存储** ✅

- 对话记录保存在用户手机本地（`wx.setStorageSync`）
- **不上传**到服务器
- 用户可**随时清除**
- 关闭重开后**仍可查看历史**
- 兼顾隐私和体验

详细说明：参考 **`LOCAL_STORAGE.md`**

---

## 📋 隐私保护措施

### ✅ 已实现的保护

#### 1. **对话记录不存数据库**
- ❌ 不保存用户消息
- ❌ 不保存 AI 回复
- ❌ 不保存聊天内容
- ✅ 仅统计对话次数（不含内容）

#### 2. **历史记录仅存内存**
- 对话历史保存在前端 `this.data.messages`
- 关闭小程序后自动清空
- 重新进入聊天页面，历史消失

#### 3. **上下文支持仍然可用**
- 前端将最近3轮对话传给云函数
- AI 仍能理解上下文
- 但不需要数据库存储

---

## 🏗️ 技术实现

### 前端（pages/chat/chat.js）

#### 发送消息时
```javascript
async sendMessage() {
  // 1. 构建历史记录（从内存中获取）
  const currentMessages = this.data.messages  // 内存中的消息
  const recentMessages = currentMessages.slice(-6)  // 最近6条
  const history = recentMessages.map(msg => ({
    role: msg.role === 'user' ? 'user' : 'assistant',
    content: msg.content
  }))

  // 2. 传递给云函数
  await wx.cloud.callFunction({
    name: 'aiChat',
    data: {
      message,
      history  // ✅ 传入历史，云函数不再查数据库
    }
  })
}
```

**特点：**
- 历史记录来自 `this.data.messages`
- 每次调用时动态构建
- 关闭页面后自动清空

---

### 后端（cloudfunctions/aiChat/index.js）

#### 接收历史记录
```javascript
exports.main = async (event, context) => {
  const { message, history = [] } = event  // 从前端接收历史

  // ❌ 不再保存消息
  // await saveMessage(...)  // 已移除

  // ✅ 直接使用前端传来的历史
  if (AI_ENABLED) {
    reply = await generateReplyWithAI(message, history)
  }

  // ❌ 不再保存回复
  // await saveMessage(...)  // 已移除

  return { success: true, data: { reply } }
}
```

**特点：**
- 不再调用 `saveMessage()`
- 不再调用 `getChatHistory()`
- 历史记录完全由前端管理

---

## 🔍 数据流对比

### 旧方案（持久化存储）❌

```
用户发送消息
    ↓
存入数据库 (chat_logs)  ← 🔴 隐私风险
    ↓
云函数从数据库读取历史
    ↓
调用 AI API
    ↓
AI 回复存入数据库  ← 🔴 隐私风险
    ↓
返回给用户
```

**问题：**
- 所有对话永久保存在数据库
- 可能包含敏感信息（姓名、电话、银行卡等）
- 数据泄露风险

---

### 新方案（内存存储）✅

```
用户发送消息
    ↓
保存到前端内存 (this.data.messages)  ← ✅ 临时存储
    ↓
前端构建最近3轮对话
    ↓
传递给云函数（不查数据库）  ← ✅ 不持久化
    ↓
调用 AI API
    ↓
AI 回复返回前端（不存数据库）  ← ✅ 不持久化
    ↓
保存到前端内存  ← ✅ 临时存储
    ↓
关闭小程序 → 自动清空  ← ✅ 自动销毁
```

**优势：**
- ✅ 对话内容不持久化
- ✅ 关闭小程序后自动清空
- ✅ 无数据泄露风险
- ✅ 符合隐私保护要求

---

## 📊 保留的统计数据

### 仍然记录的信息

| 数据类型 | 是否保存 | 说明 |
|---------|---------|------|
| **对话内容** | ❌ 不保存 | 保护隐私 |
| **历史消息** | ❌ 不保存 | 保护隐私 |
| **对话次数** | ✅ 保存 | 仅统计数量，无内容 |
| **用户 openid** | ✅ 保存 | 系统必需，无隐私风险 |
| **最后对话时间** | ✅ 可选 | 用于统计活跃度 |

**示例（users 表）：**
```json
{
  "_id": "xxx",
  "_openid": "oABCD123",
  "nickName": "张三",
  "totalChatCount": 15,  // ✅ 仅记录次数
  "lastChatAt": "2026-01-08"  // ✅ 仅记录时间
  // ❌ 不包含任何对话内容
}
```

---

## 🔐 隐私保护等级

### Level 1：当前方案（推荐）✅

**特点：**
- 对话内容不持久化
- 关闭小程序后清空
- 仍支持上下文（3轮对话）

**适用场景：**
- 反诈骗咨询
- 隐私敏感的对话
- 大部分小程序场景

---

### Level 2：完全无记忆

**实现：**
```javascript
// 前端发送时不传历史
await wx.cloud.callFunction({
  name: 'aiChat',
  data: {
    message,
    // history: []  // 不传历史
  }
})
```

**特点：**
- 每次对话独立
- AI 无上下文理解
- 最高隐私保护

**适用场景：**
- 极度敏感场景
- 单次咨询

---

### Level 3：用户可选清除

**实现：**
```javascript
// 添加「清除历史」按钮
clearHistory() {
  this.setData({ messages: [] })
  wx.showToast({ title: '已清除对话记录' })
}
```

**特点：**
- 用户主动控制
- 灵活性高

---

## 🛡️ 安全性分析

### ✅ 优势

#### 1. 无数据库存储风险
```
✅ 数据库被攻击 → 无对话内容泄露
✅ 内部人员误操作 → 查不到对话内容
✅ 监管要求提供数据 → 没有存储任何内容
```

#### 2. 自动销毁
```
关闭小程序 → 内存清空 → 对话消失
```

#### 3. 用户控制
```
用户随时可以：
- 关闭小程序清空记录
- 不用担心数据被滥用
```

---

### ⚠️ 权衡

#### 限制 1：无法跨设备同步
```
iPhone 上的对话 ≠ iPad 上的对话
```

**影响：** 用户换设备后，历史对话不同步
**适用场景：** 反诈骗咨询不需要跨设备同步

---

#### 限制 2：无法查看历史
```
关闭后重新打开 → 历史清空
```

**影响：** 用户无法查看之前的对话
**适用场景：** 反诈骗咨询重视隐私 > 历史查询

---

#### 限制 3：无法做数据分析
```
无法分析：
- 常见诈骗类型
- 用户咨询热点
- AI 回复质量
```

**解决：** 可以记录**匿名统计数据**（见下方）

---

## 📈 匿名统计方案（可选）

### 如果需要改进 AI，可以记录匿名统计

```javascript
// 仅记录关键词和类型，不记录完整内容
await db.collection('anonymous_stats').add({
  data: {
    category: '刷单骗局',  // 诈骗类型
    timestamp: new Date(),
    // ❌ 不保存完整消息
    // ❌ 不保存 openid
  }
})
```

**示例（anonymous_stats 表）：**
```json
{
  "category": "校园贷",
  "timestamp": "2026-01-08 22:30:00",
  "region": "北京"  // 可选：地区（不精确到个人）
}
```

**用途：**
- 统计各类诈骗咨询量
- 优化 AI 提示词
- 完全匿名，无隐私风险

---

## 🔄 迁移步骤

### 已完成的修改 ✅

#### 1. 云函数（cloudfunctions/aiChat/index.js）
- ✅ 移除 `saveMessage()` 调用
- ✅ 移除 `getChatHistory()` 调用
- ✅ 接收前端传来的 `history` 参数
- ✅ 保留 `totalChatCount` 统计

#### 2. 前端（pages/chat/chat.js）
- ✅ 从内存构建历史记录
- ✅ 传递 `history` 给云函数
- ✅ 消息存在 `this.data.messages`

---

### 数据库清理（可选）

#### 如果之前已有数据，可以删除

```javascript
// 删除旧的聊天记录（在云函数中执行）
const result = await db.collection('chat_logs').get()
console.log(`共有 ${result.data.length} 条记录`)

// 确认后执行删除
// await db.collection('chat_logs').where({}).remove()
```

**提示：** 
- 删除前请备份
- 可以保留 `users` 表（不含对话内容）

---

## 🧪 测试验证

### 测试 1：对话功能正常

```
1. 发送消息："你好"
2. 收到 AI 回复 ✅
3. 继续对话："什么是刷单骗局？"
4. AI 能理解上下文 ✅
```

---

### 测试 2：历史记录不持久化

```
1. 进行多轮对话
2. 查看 云开发控制台 → chat_logs 集合
3. 确认：无新增记录 ✅
```

---

### 测试 3：关闭后清空

```
1. 进行对话
2. 关闭小程序
3. 重新打开「AI助手」页面
4. 确认：历史清空，只显示欢迎消息 ✅
```

---

## 📚 用户说明

### 建议在 AI 助手页面添加提示

```javascript
// 在欢迎消息中说明
<view class="privacy-notice">
  🔒 隐私保护：您的对话内容不会被保存，
  关闭小程序后自动清空。
</view>
```

**WXML 示例：**
```xml
<view class="message bot">
  <view class="message-avatar">🤖</view>
  <view class="message-content">
    <text>🔒 隐私提示：为保护您的隐私，对话记录仅保存在本地，关闭小程序后自动清空。\n\n你好！我是反诈AI助手，可以帮你：\n\n• 解答反诈骗问题\n• 识别可疑信息\n• 提供防骗建议\n\n有什么可以帮你的吗？</text>
  </view>
</view>
```

---

## 🎯 总结

### ✅ 隐私保护方案优势

| 方面 | 说明 |
|------|------|
| **隐私安全** | ⭐⭐⭐⭐⭐ 对话内容不持久化 |
| **上下文支持** | ⭐⭐⭐⭐ 仍支持3轮对话理解 |
| **用户体验** | ⭐⭐⭐⭐ 正常对话，无感知 |
| **开发成本** | ⭐⭐⭐⭐⭐ 已完成修改 |
| **合规性** | ⭐⭐⭐⭐⭐ 符合隐私保护要求 |

---

### 🚀 立即部署

1. ✅ 云函数已修改
2. ✅ 前端已修改
3. **重新部署云函数**
4. **重新编译小程序**
5. 测试验证

---

### 📋 检查清单

- [x] 移除 `saveMessage()` 调用
- [x] 移除 `getChatHistory()` 调用
- [x] 前端构建历史记录
- [x] 传递 `history` 参数
- [ ] 重新部署云函数
- [ ] 测试对话功能
- [ ] 验证数据库无新记录
- [ ] 添加隐私提示（可选）

---

**隐私保护方案已完成！重新部署后即可生效。** 🎉

**用户隐私安全 > 功能便利性** 🔒

