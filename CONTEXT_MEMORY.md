# AI 上下文记忆功能说明

## 📝 功能概述

AI 助手现在具备**上下文记忆能力**，可以记住最近的对话内容，实现更智能的多轮对话。

---

## 🎯 实现原理

### 1. 前端记忆管理

**文件：`pages/chat/chat.js`**

```javascript
// 获取最近5轮对话（10条消息）
const recentMessages = currentMessages.slice(-10)
const history = recentMessages.map(msg => ({
  role: msg.role === 'user' ? 'user' : 'assistant',
  content: msg.content
}))

// 传递给云函数
wx.cloud.callFunction({
  name: 'aiChat',
  data: {
    message,
    history  // 包含最近5轮对话
  }
})
```

**记忆容量：**
- **5轮对话**（10条消息）
- 用户消息 + AI回复 = 1轮对话
- 示例：用户问5次，AI答5次 = 5轮

---

### 2. 云函数上下文处理

**文件：`cloudfunctions/aiChat/index.js`**

```javascript
// 构建消息列表
const messages = [
  { role: 'system', content: systemPrompt },  // 系统提示词
  ...history,                                  // 历史对话（5轮）
  { role: 'user', content: message }          // 当前问题
]

// 传递给 Qwen API
await axios.post(QWEN_API_URL, {
  model: 'qwen-turbo',
  input: { messages }
})
```

---

### 3. 系统提示词优化

AI 被明确告知具备记忆能力：

```
上下文记忆能力：
- 你会收到用户最近几轮的对话历史
- 请基于对话历史理解用户的问题，保持对话连贯性
- 如果用户追问"那怎么办"、"还有呢"等，请结合上文回答
- 记住用户提到的具体情况（如金额、平台、对方话术等）
```

---

## 💡 使用示例

### 示例 1：连续追问

```
用户：什么是刷单诈骗？

AI：刷单兼职诈骗是针对大学生的常见骗局。
    诈骗分子发布高薪招聘信息...
    
用户：那怎么识别呢？

AI：识别刷单诈骗，可以注意以下几点：
    • 正规企业不会让员工垫付资金
    • 高薪兼职广告要警惕
    ...（基于上文"刷单诈骗"回答）
    
用户：如果已经被骗了怎么办？

AI：如果您已经遭遇刷单诈骗，请立即采取以下措施：
    • 第一时间拨打96110报警
    • 保存所有聊天记录和转账凭证
    ...（记住了"刷单诈骗"的上下文）
```

### 示例 2：记住用户情况

```
用户：我在网上看到一个兼职，说是刷单日赚500，要先垫付1000元。

AI：这是典型的刷单诈骗！您描述的情况有明显的诈骗特征：
    • 高薪诱惑（日赚500）
    • 要求垫付本金（1000元）
    请不要相信，更不要转账！
    
用户：那我该怎么回复他们？

AI：针对您遇到的这个要求垫付1000元的"刷单兼职"，建议您：
    • 直接不理会，拉黑删除
    • 不要与对方继续交流
    ...（记住了"垫付1000元"的具体细节）
```

### 示例 3：对话延续

```
用户：校园贷有哪些风险？

AI：校园贷主要有以下风险：
    • 高利率陷阱，利滚利
    • 暴力催收
    ...
    
用户：还有呢？

AI：除了刚才提到的高利率和暴力催收，校园贷还有：
    • 个人信息泄露风险
    • 影响个人征信记录
    ...（基于上文"校园贷风险"继续回答）
```

---

## 🔧 技术细节

### 记忆机制

| 项目 | 说明 |
|------|------|
| **存储位置** | 用户手机本地（`wx.setStorageSync`） |
| **记忆容量** | 最近5轮对话（10条消息） |
| **传输方式** | 每次调用云函数时传递 |
| **隐私保护** | 不在服务器持久化存储 |
| **清除方式** | 点击「清除历史」按钮 |

### 消息格式

```javascript
// 前端格式
{
  id: 1234567890,
  role: 'user',       // 'user' 或 'bot'
  content: '消息内容'
}

// 传递给云函数
{
  role: 'user',       // 'user' 或 'assistant'
  content: '消息内容'
}

// 传递给 Qwen API
{
  role: 'system',     // 系统提示词
  content: '...'
},
{
  role: 'user',       // 用户消息
  content: '...'
},
{
  role: 'assistant',  // AI回复
  content: '...'
}
```

---

## 🎨 用户体验优化

### 1. 欢迎消息提示

在首次进入时，欢迎消息会提示用户：

```
💡 我会记住最近5轮对话，所以您可以追问"那怎么办"、"还有呢"等问题，
我会基于之前的对话内容回答。
```

### 2. 清除历史功能

用户可以随时清除历史记录：
- 点击右上角「🗑️ 清除历史」按钮
- 清除后上下文记忆重置

### 3. 隐私保护

- ✅ 对话记录仅保存在本地
- ✅ 不在服务器持久化
- ✅ 用户完全控制

---

## 📊 性能优化

### 1. 消息数量限制

```javascript
// 前端：最多保存100条消息
const messagesToSave = messages.slice(-100)

// 云函数：只使用最近10条（5轮）
const recentMessages = currentMessages.slice(-10)
```

### 2. Token 消耗控制

每次调用包含：
- 系统提示词：~300 tokens
- 历史对话（10条）：~500 tokens
- 当前问题：~50 tokens
- AI回复：~200 tokens

**总计：~1050 tokens/次**（在合理范围内）

### 3. 响应速度

- 上下文记忆不影响响应速度
- 仍然保持 5-10 秒的回复时间

---

## 🧪 测试步骤

### 测试 1：连续追问

1. 发送：「什么是刷单诈骗？」
2. 发送：「那怎么识别呢？」
3. 验证：AI 回答应该基于"刷单诈骗"

### 测试 2：记住细节

1. 发送：「我遇到一个兼职要垫付1000元」
2. 发送：「怎么办？」
3. 验证：AI 应该提到"1000元"

### 测试 3：对话延续

1. 发送：「校园贷有什么风险？」
2. 发送：「还有呢？」
3. 验证：AI 应该继续补充风险

### 测试 4：清除记忆

1. 进行几轮对话
2. 点击「清除历史」
3. 发送新消息
4. 验证：AI 不记得之前的对话

---

## 🔄 工作流程

```
用户输入消息
    ↓
前端获取最近10条消息（5轮）
    ↓
构建 history 数组
    ↓
调用云函数（传入 message + history）
    ↓
云函数构建完整消息列表（system + history + current）
    ↓
调用 Qwen API
    ↓
清理回复内容（去除 emoji 和 Markdown）
    ↓
返回给前端
    ↓
前端显示（楷体）
    ↓
保存到本地存储
```

---

## 💡 优势

### 1. 智能对话
- ✅ 理解上下文
- ✅ 支持追问
- ✅ 记住用户情况

### 2. 隐私保护
- ✅ 本地存储
- ✅ 不在服务器持久化
- ✅ 用户可控

### 3. 简单高效
- ✅ 实现简单
- ✅ 无需向量数据库
- ✅ 无需复杂的 RAG

### 4. 成本可控
- ✅ Token 消耗合理
- ✅ 响应速度快

---

## 📈 未来可扩展

如果需要更强的记忆能力，可以考虑：

1. **对话摘要**：将长对话压缩为摘要
2. **关键信息提取**：提取用户的关键情况（金额、平台等）
3. **长期记忆**：使用向量数据库存储重要信息
4. **个性化**：记住用户的偏好和特点

但目前的简单实现已经足够满足反诈场景的需求。

---

## ✅ 总结

**当前实现：**
- 记忆：5轮对话（10条消息）
- 存储：本地存储（隐私保护）
- 传输：每次调用传递
- 智能：支持追问和上下文理解

**效果：**
- 用户可以自然地追问"那怎么办"、"还有呢"
- AI 能记住用户提到的具体情况
- 对话更自然、更连贯

**简单但实用！** ✨
