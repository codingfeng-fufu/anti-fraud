# 微信小程序云开发快速入门

## 📋 前置准备

- ✅ 已安装微信开发者工具
- ✅ 已有微信小程序账号（可使用测试号）
- ✅ 项目代码已完成

---

## 🚀 第一步：开通云开发环境

### 1. 打开云开发控制台

1. 在微信开发者工具中打开项目
2. 点击顶部工具栏的「云开发」按钮
3. 首次使用需要开通云开发

### 2. 创建云环境

1. 点击「开通」按钮
2. 填写环境名称（如：`anti-fraud-prod`）
3. 选择套餐版本（开发阶段选择**免费版**即可）
4. 等待环境创建完成（约1-2分钟）

### 3. 获取环境 ID

创建完成后，在云开发控制台可以看到环境 ID（如：`anti-fraud-xxxxx`）

**重要：** 复制这个环境 ID，稍后需要填入代码中！

---

## 🔧 第二步：配置项目代码

### 1. 修改 app.js

打开 `app.js`，找到以下代码：

```javascript
wx.cloud.init({
  env: 'your-env-id', // ← 替换这里
  traceUser: true,
})
```

将 `'your-env-id'` 替换为你的云开发环境 ID：

```javascript
wx.cloud.init({
  env: 'anti-fraud-xxxxx', // ← 填入你的环境ID
  traceUser: true,
})
```

### 2. 验证配置

在微信开发者工具中：
1. 点击「编译」按钮
2. 查看控制台是否有错误
3. 如无错误，说明云开发初始化成功

---

## 💾 第三步：创建数据库集合

### 1. 进入数据库管理

云开发控制台 → 数据库 → 点击「+」创建集合

### 2. 创建以下集合

按顺序创建这些集合（注意名称必须完全一致）：

| 集合名称 | 说明 |
|---------|------|
| `users` | 用户信息表 |
| `articles` | 文章表 |
| `chat_logs` | 对话记录表 |
| `sign_records` | 签到记录表 |
| `user_achievements` | 用户成就表 |
| `read_records` | 阅读记录表 |

每个集合创建后，暂时不需要添加数据。

---

## ☁️ 第四步：部署云函数

### 方法一：通过开发者工具部署（推荐）

1. **部署 login 云函数**
   - 在微信开发者工具左侧文件树找到 `cloudfunctions/login`
   - 右键点击 `login` 文件夹
   - 选择「上传并部署：云端安装依赖」
   - 等待部署完成（首次会较慢，约1-2分钟）

2. **部署其他云函数**
   - 重复以上步骤，依次部署：
     - `userSignIn`
     - `getArticles`
     - `getArticleDetail`
     - `aiChat`

3. **验证部署**
   - 云开发控制台 → 云函数
   - 查看是否显示所有5个云函数
   - 状态应为「正常」

### 方法二：通过云开发控制台部署

1. 进入云开发控制台 → 云函数
2. 点击「新建云函数」
3. 输入函数名（如 `login`）
4. 将对应文件夹中的 `index.js` 代码粘贴进去
5. 点击「保存并安装依赖」

---

## 📝 第五步：导入示例数据

### 1. 导入文章数据

1. 进入云开发控制台 → 数据库 → `articles` 集合
2. 点击「导入」按钮
3. 选择 JSON 格式
4. 粘贴以下示例数据：

```json
[
  {
    "title": "警惕！"刷单兼职"骗局又出新花样，多名学生被骗",
    "category": "大学生",
    "tag": "紧急预警",
    "tagType": "danger",
    "viewCount": 12300,
    "likeCount": 328,
    "publishTime": {"$date": "2026-01-07T02:30:00.000Z"},
    "content": "<p>近期，多名大学生在网上寻找兼职时遭遇"刷单诈骗"，损失金额从几百元到数万元不等。警方提醒广大学生，要警惕此类骗局。</p><h3>诈骗手法揭秘</h3><p>骗子通常会在社交平台发布高薪招聘信息，声称日赚300-500元，最初会让你完成小额任务并返利，等你放松警惕后，要求大额垫付，最终失联跑路。</p>",
    "author": "反诈中心"
  },
  {
    "title": "大学生网购遇"退款诈骗"，一步步掉入陷阱",
    "category": "大学生",
    "tag": "案例分析",
    "tagType": "warning",
    "viewCount": 8700,
    "likeCount": 215,
    "publishTime": {"$date": "2026-01-07T00:15:00.000Z"},
    "content": "<p>大三学生小李在某电商平台购买了一件衣服，第二天接到"客服"电话，称商品有质量问题需要退款。在"客服"的指导下，小李下载了一个"退款专用APP"，结果卡里的5000元被转走。</p>",
    "author": "反诈中心"
  },
  {
    "title": "校园贷、培训贷...大学生必知的5种贷款陷阱",
    "category": "大学生",
    "tag": "防骗知识",
    "tagType": "info",
    "viewCount": 15200,
    "likeCount": 456,
    "publishTime": {"$date": "2026-01-06T10:30:00.000Z"},
    "content": "<p>校园贷、培训贷是大学生需要警惕的陷阱！常见套路包括：低门槛、利息极高、暴力催收等。</p>",
    "author": "反诈中心"
  }
]
```

5. 点击「确定导入」

### 2. 添加更多分类的文章

可以继续添加不同分类的文章，涵盖：
- 老年人、儿童、教师、企业员工（人群分类）
- 杀猪盘、电信诈骗、钓鱼邮件、网络贷款、刷单诈骗、投资理财（诈骗类型）

---

## 🔐 第六步：配置数据库权限

### 1. 设置集合权限

为每个集合设置合适的权限：

#### users 集合权限
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### articles 集合权限（所有人可读）
```json
{
  "read": true,
  "write": false
}
```

#### 其他集合权限（私有数据）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 2. 设置方法

1. 进入数据库管理
2. 选择集合
3. 点击「权限设置」
4. 选择「自定义安全规则」
5. 粘贴权限配置
6. 保存

---

## ✅ 第七步：测试功能

### 1. 测试用户登录

1. 在小程序中进入「我的」页面
2. 点击用户头像登录
3. 授权后检查：
   - 云开发控制台 → 数据库 → `users` 集合
   - 应该能看到新增的用户记录

### 2. 测试签到功能

1. 点击「每日签到」
2. 查看是否显示签到成功
3. 检查数据库：
   - `sign_records` 集合应该有新记录
   - `users` 集合中对应用户的积分应该增加

### 3. 测试文章列表

1. 进入「首页」
2. 查看是否显示导入的文章
3. 点击文章卡片，跳转到详情页
4. 检查浏览量是否增加

### 4. 测试AI对话

1. 进入「AI助手」页面
2. 发送消息「刷单诈骗」
3. 查看是否收到AI回复
4. 检查 `chat_logs` 集合是否保存了对话记录

---

## 🎉 完成！

恭喜你已经成功配置了云开发环境！

### 接下来可以：

✅ **测试所有功能** - 确保每个功能正常工作  
✅ **添加更多文章** - 丰富内容库  
✅ **自定义AI回复** - 修改 `aiChat` 云函数  
✅ **优化用户体验** - 添加加载动画、错误提示  
✅ **接入真实AI** - 集成讯飞星火、文心一言等  

---

## 📊 监控与维护

### 查看云函数日志

云开发控制台 → 云函数 → 选择函数 → 日志

### 查看数据库使用情况

云开发控制台 → 统计分析 → 查看存储、流量使用

### 免费额度

- 存储：2GB
- 流量：5GB/月
- 云函数调用：10万次/月
- 数据库读操作：5万次/天

**超出部分按量计费，建议做好成本控制！**

---

## ❓ 常见问题

### Q1: 云函数调用失败，提示 "errCode: -404011"
**A:** 云函数未部署或部署失败
- 检查云开发控制台，确认云函数存在
- 重新上传并部署云函数

### Q2: 数据库写入失败
**A:** 权限配置问题
- 检查数据库权限设置
- 确保用户已登录（有 openid）

### Q3: 首页不显示文章
**A:** 
- 检查是否导入了示例数据
- 查看云函数 `getArticles` 的日志
- 确认 `articles` 集合权限为可读

### Q4: 环境 ID 在哪里找？
**A:** 云开发控制台 → 设置 → 环境名称下方

### Q5: 如何切换环境（开发/生产）？
**A:** 在 `app.js` 中修改 `env` 参数

---

## 📚 参考文档

- [微信小程序云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云函数开发指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html)
- [云数据库文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html)

---

**祝你开发顺利！🎊**

如有问题，欢迎查看项目文档或联系技术支持。

