# 云数据库权限设置指南

## 🚨 问题

小程序查询文章时，自动添加了 `_openid` 条件，导致查不到数据。

## 🔍 原因

云数据库默认权限是"**仅创建者可读写**"，这会导致：
- 查询时自动过滤：只返回当前用户创建的记录
- 其他用户无法查看文章

## ✅ 解决方案：修改数据库权限

### 方法 1：通过 Web 控制台修改（推荐）

#### 1.1 打开云开发控制台

```
浏览器访问：https://console.cloud.tencent.com/tcb
登录 → 选择环境：cloud1-9g3v8lt8fb0108e7
```

#### 1.2 进入数据库

```
左侧菜单 → 数据库 → articles 集合
```

#### 1.3 修改权限

```
1. 点击「权限设置」或「设置」按钮
2. 找到「权限设置」选项
3. 选择权限模式：「自定义安全规则」
4. 输入以下规则：
```

**推荐权限规则（所有用户可读，仅创建者可写）：**

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

或者使用简化版：

```json
{
  "read": "true",
  "write": "doc._openid == auth.openid"
}
```

**说明：**
- `"read": true` - 所有用户可读（不限制）
- `"write": "doc._openid == auth.openid"` - 只有创建者可写

#### 1.4 保存

点击「保存」或「确定」

---

### 方法 2：通过微信开发者工具

#### 2.1 打开云开发控制台

```
微信开发者工具 → 顶部「云开发」按钮 → 数据库
```

#### 2.2 选择 articles 集合

#### 2.3 点击「权限设置」

#### 2.4 选择「自定义安全规则」

输入规则：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

#### 2.5 保存

---

### 方法 3：使用预设权限模板

如果看到预设选项，可以选择：

```
☐ 仅创建者可读写（默认）
☑ 所有用户可读，仅创建者可写  ✅ 选择这个
☐ 所有用户可读写
☐ 仅管理端可读写
```

---

## 🧪 验证权限是否生效

### 测试查询

修改权限后，在小程序中：

1. **重新编译小程序**
2. **进入首页**
3. **下拉刷新**
4. **查看控制台日志**

**成功的日志：**
```javascript
从云数据库加载到文章：1  ✅
文章加载成功 ✅
```

**失败的日志：**
```javascript
云数据库暂无文章，使用本地备份  ❌
```

---

## 📊 权限规则详解

### 常用权限规则

#### 1. 所有用户可读，仅创建者可写（推荐用于文章）

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**适用场景：**
- 文章列表（所有人可看）
- 内容展示

#### 2. 仅创建者可读写（默认）

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**适用场景：**
- 用户个人数据
- 收藏、点赞记录

#### 3. 所有用户可读写

```json
{
  "read": true,
  "write": true
}
```

**适用场景：**
- 公共评论
- 临时数据

**⚠️ 注意：不安全，慎用！**

#### 4. 仅管理端可读写

```json
{
  "read": false,
  "write": false
}
```

**适用场景：**
- 敏感数据
- 配置信息

---

## 🛡️ 安全最佳实践

### 针对不同集合设置不同权限

| 集合 | 权限规则 | 说明 |
|------|---------|------|
| **articles** | 所有人可读，仅创建者可写 | 文章内容 |
| **users** | 仅创建者可读写 | 用户信息 |
| **sign_records** | 仅创建者可读写 | 签到记录 |
| **user_achievements** | 仅创建者可读写 | 成就记录 |
| **chat_messages** | 不存储（本地） | 聊天记录 |

---

## 🔧 如果权限设置不生效

### 检查清单

1. **确认保存成功**
   ```
   权限规则页面应该显示你设置的规则
   ```

2. **等待几秒**
   ```
   权限更新可能需要几秒钟生效
   ```

3. **重新编译小程序**
   ```
   点击「编译」按钮
   ```

4. **清除缓存**
   ```
   微信开发者工具 → 清缓存 → 清除数据缓存
   ```

5. **检查云开发环境ID**
   ```
   确认 app.js 中的环境ID正确
   env: 'cloud1-9g3v8lt8fb0108e7'
   ```

---

## 💡 快速操作步骤

### 最快 3 步解决

```
1. 打开浏览器
   https://console.cloud.tencent.com/tcb
   
2. 数据库 → articles → 权限设置
   选择：所有用户可读，仅创建者可写
   
3. 保存 → 重新编译小程序 → 测试
```

---

## 🎯 完成后的效果

### 修改前（默认权限）
```javascript
// 查询语句
db.collection('articles').where({
  status: 'published',
  _openid: 'xxx'  // ❌ 自动添加，导致查不到
})

// 结果
云数据库暂无文章 ❌
```

### 修改后（正确权限）
```javascript
// 查询语句
db.collection('articles').where({
  status: 'published'  // ✅ 没有 _openid 限制
})

// 结果
从云数据库加载到文章：1 ✅
```

---

## 🚀 下一步

修改权限后：

1. **重新编译小程序**
2. **进入首页**
3. **下拉刷新**
4. **应该能看到文章了！** ✅

---

## ❓ 常见问题

### Q: 修改权限会影响已有数据吗？

**不会！** 只影响访问权限，不影响数据本身。

### Q: 如果设置错了怎么办？

**可以随时修改！** 重新进入权限设置页面修改即可。

### Q: 为什么要限制写权限？

**安全考虑！** 防止恶意用户篡改或删除文章。

### Q: CMS 创建的文章有 _openid 吗？

**有！** CMS 创建时会自动添加创建者的 _openid。

---

**立即去修改权限，问题就解决了！** 🎊
