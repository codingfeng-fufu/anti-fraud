# 学号绑定功能使用指南

## 🎓 功能概述

已为反诈卫士小程序添加**学号绑定系统**，面向学校场景，支持强制绑定学号。

---

## ✨ 功能特点

### 1. **智能登录流程**
```
用户打开小程序
    ↓
自动登录（获取 openid）
    ↓
检查是否已绑定学号
    ↓
未绑定 → 弹窗提示绑定
已绑定 → 正常使用
```

### 2. **完整信息收集**

| 字段 | 类型 | 说明 |
|------|------|------|
| 学号 | 必填 | 唯一标识，支持格式验证 |
| 学校 | 必填 | 下拉选择 |
| 真实姓名 | 选填 | 可用于实名认证 |
| 院系 | 选填 | 关联学校 |
| 专业 | 选填 | 关联院系 |
| 年级 | 选填 | 2024级/2023级等 |
| 手机号 | 选填 | 11位手机号验证 |

### 3. **安全验证**
- ✅ 学号格式验证（正则表达式）
- ✅ 学号唯一性检查
- ✅ 手机号格式验证
- ✅ 数据加密存储

### 4. **激励机制**
- 🎁 首次绑定奖励 **50 积分**
- 📊 数据统计（各学校/院系人数）
- 🏆 可扩展成就系统

---

## 📁 文件结构

```
✅ 已创建的文件：

pages/bind-student/          # 学号绑定页面
├── bind-student.js
├── bind-student.wxml
├── bind-student.wxss
└── bind-student.json

cloudfunctions/
├── bindStudent/             # 绑定学号云函数
│   ├── index.js
│   ├── config.json
│   └── package.json
├── getSchools/              # 获取学校/院系/专业
│   ├── index.js
│   ├── config.json
│   └── package.json
├── database.md              # 数据库设计（已更新）
└── SCHOOL_DATA.md           # 学校数据示例
```

---

## 🚀 部署步骤

### 步骤 1：创建数据库集合

在云开发控制台创建以下集合：

```
1. schools     - 学校表
2. colleges    - 院系表
3. majors      - 专业表
4. bind_logs   - 绑定日志表（可选）
```

### 步骤 2：导入学校数据

参考 `cloudfunctions/SCHOOL_DATA.md`，导入示例数据：

```
云开发控制台 → 数据库 → schools 集合 → 导入
粘贴 JSON 数据 → 确定导入
```

最少导入 1-2 所学校即可测试。

### 步骤 3：部署云函数

```
右键 cloudfunctions/bindStudent → 上传并部署：云端安装依赖
右键 cloudfunctions/getSchools → 上传并部署：云端安装依赖
```

### 步骤 4：配置数据库权限

```
schools、colleges、majors 集合：
{
  "read": true,
  "write": false
}
```

### 步骤 5：测试功能

```
1. 重新编译项目
2. 打开小程序
3. 2秒后会弹出绑定提示
4. 点击「去绑定」进入绑定页面
```

---

## 📱 用户使用流程

### 首次打开小程序

```
第1步：自动登录（后台完成）
    ↓
第2步：2秒后弹窗「完善学生信息」
    ↓
第3步：点击「去绑定」
    ↓
第4步：填写信息
    - 选择学校（必填）
    - 输入学号（必填）
    - 选填其他信息
    ↓
第5步：点击「提交绑定」
    ↓
第6步：绑定成功，获得 50 积分
```

### 已绑定用户

- 直接使用，无需再次绑定
- 可在「我的」页面查看绑定信息

---

## 🎨 界面展示

### 绑定页面设计

- 🎨 **渐变色顶部**：蓝青色渐变
- 📝 **表单布局**：清晰的字段分组
- 🔍 **下拉选择器**：学校/院系/专业三级联动
- 💡 **智能提示**：学号格式示例
- ✨ **友好提示**：数据加密、积分奖励
- 🎯 **大按钮**：易于点击的提交按钮

---

## 🔧 高级配置

### 1. 修改绑定策略

在 `app.js` 中修改：

```javascript
// 当前：温和提示，用户可以取消
// 修改为强制绑定：
checkStudentBind(userInfo) {
  if (!userInfo.isBound) {
    wx.redirectTo({  // 使用 redirectTo 无法返回
      url: '/pages/bind-student/bind-student'
    })
  }
}
```

### 2. 修改提示时机

```javascript
// 当前：小程序启动 2 秒后提示
// 可修改为：首次进入首页时提示
// 或：使用某功能时提示（如签到）
```

### 3. 添加更多验证

在 `cloudfunctions/bindStudent/index.js` 中添加：

```javascript
// 验证真实姓名（对接学校API）
if (realName) {
  const verified = await verifyWithSchool(studentId, realName)
  if (!verified) {
    return { success: false, errMsg: '姓名与学号不匹配' }
  }
}
```

---

## 📊 数据统计

### 查看绑定情况

云开发控制台 → 数据库 → users 集合

筛选条件：
```json
{
  "isBound": true
}
```

### 统计各学校人数

```javascript
db.collection('users').where({
  isBound: true
}).count()
```

### 导出数据

云开发控制台 → 数据库 → users 集合 → 导出

---

## 🎯 使用场景

### 场景 1：单个学校部署

```
1. 只导入一所学校数据
2. 用户选择时只有一个选项
3. 适合校内推广
```

### 场景 2：多校联盟

```
1. 导入多所学校数据
2. 用户可选择自己的学校
3. 适合区域推广
```

### 场景 3：分级管理

```
1. 学校管理员管理本校数据
2. 院系管理员查看本院数据
3. 需要开发管理后台
```

---

## 🔐 隐私保护

### 数据加密

建议对敏感信息加密：

```javascript
// 在云函数中加密存储
const crypto = require('crypto');

function encrypt(text) {
  const cipher = crypto.createCipher('aes-256-cbc', 'your-secret-key');
  return cipher.update(text, 'utf8', 'hex') + cipher.final('hex');
}

// 加密学号
updateData.studentId = encrypt(studentId);
```

### 权限控制

```json
// users 集合权限
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 隐私协议

建议添加隐私协议页面：

```
pages/privacy/privacy.wxml
```

内容包括：
- 数据收集目的
- 数据使用范围
- 数据保护措施
- 用户权利

---

## ❓ 常见问题

### Q1: 学号格式验证失败？

**原因：** 正则表达式不匹配

**解决：**
```
云开发控制台 → schools 集合 → 编辑学校记录
修改 studentIdPattern 字段
如：U\\d{10} 表示 U开头+10位数字
```

### Q2: 学号已被使用？

**原因：** 该学号已绑定其他账号

**解决：**
```
云开发控制台 → users 集合 → 搜索学号
确认是否重复，可删除旧记录
```

### Q3: 无法选择院系/专业？

**原因：** 数据库中没有该学校的院系数据

**解决：**
```
导入院系数据到 colleges 集合
导入专业数据到 majors 集合
```

### Q4: 绑定后如何修改？

**当前：** 绑定后不可修改

**扩展：** 可添加修改功能
```
pages/edit-student/edit-student
允许用户修改非关键信息（如手机号）
学号不允许修改
```

---

## 🎁 激励机制

### 当前奖励

- 首次绑定：**50 积分**

### 可扩展奖励

```javascript
// 完善信息程度奖励
if (realName && phone && collegeId && majorId) {
  points += 30;  // 完整信息额外 30 积分
}

// 推荐同学绑定奖励
if (referralCode) {
  points += 20;  // 推荐人获得 20 积分
}
```

---

## 🚀 扩展功能

### 1. 学号验证码

通过学校邮箱验证：

```
输入学号 → 发送验证码到学校邮箱
输入验证码 → 验证通过绑定
```

### 2. 批量导入

管理员批量导入学生名单：

```
上传 Excel → 解析数据 → 批量创建账号
```

### 3. 数据同步

与学校教务系统对接：

```
定时任务 → 同步学生信息 → 更新数据库
```

### 4. 统计看板

数据可视化展示：

```
各学校绑定率
各院系活跃度
时间趋势图
```

---

## 📝 开发检查清单

- [x] 创建数据库表结构
- [x] 创建云函数（bindStudent、getSchools）
- [x] 创建绑定页面
- [x] 更新登录流程
- [x] 添加自动提示
- [ ] 导入学校数据 ⚠️ **需要手动操作**
- [ ] 部署云函数 ⚠️ **需要手动操作**
- [ ] 测试绑定流程
- [ ] 配置数据权限

---

## 🎉 总结

学号绑定功能已完整开发！

**核心特点：**
- ✅ 自动登录 + 智能提示
- ✅ 完整的信息收集
- ✅ 严格的数据验证
- ✅ 友好的用户体验
- ✅ 安全的数据存储

**下一步：**
1. 导入学校数据
2. 部署云函数
3. 测试功能
4. 根据反馈优化

---

**祝部署顺利！🎊**

