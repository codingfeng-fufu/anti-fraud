# åè¯ˆå«å£«å°ç¨‹åº v1.1 æˆå°±ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. æˆå°±ç³»ç»Ÿæ¦‚è¿°

æˆå°±ç³»ç»Ÿæ˜¯v1.1ç‰ˆæœ¬çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œé€šè¿‡æ¸¸æˆåŒ–çš„æ–¹å¼æ¿€åŠ±ç”¨æˆ·å‚ä¸åè¯ˆå­¦ä¹ ã€‚ç³»ç»Ÿå°†åŸºäºç”¨æˆ·çš„ç­¾åˆ°ã€å¯¹è¯ã€å­¦ä¹ è¡Œä¸ºè‡ªåŠ¨è§£é”æˆå°±ï¼Œå¹¶ç»™äºˆç›¸åº”çš„ç§°å·å¥–åŠ±ã€‚

## 2. æˆå°±åˆ†ç±»è®¾è®¡

### 2.1 ç­¾åˆ°ç±»æˆå°±
| æˆå°±ID | åç§° | æ¡ä»¶ | å¥–åŠ± | æè¿° |
|--------|------|------|------|------|
| sign_1 | åˆæ¬¡ç­¾åˆ° | ç­¾åˆ°1å¤© | 10ç§¯åˆ† | å®Œæˆé¦–æ¬¡ç­¾åˆ° |
| sign_7 | åšæŒä¸æ‡ˆ | è¿ç»­ç­¾åˆ°7å¤© | 50ç§¯åˆ† + "ä¸ƒæ—¥å‹¤å‹‰"ç§°å· | è¿ç»­ç­¾åˆ°ä¸€å‘¨ |
| sign_30 | æœˆåº¦å† å†› | è¿ç»­ç­¾åˆ°30å¤© | 200ç§¯åˆ† + "ç­¾åˆ°å¤§å¸ˆ"ç§°å· | è¿ç»­ç­¾åˆ°ä¸€ä¸ªæœˆ |
| sign_100 | ç™¾æ—¥ä¼ å¥‡ | è¿ç»­ç­¾åˆ°100å¤© | 1000ç§¯åˆ† + "ç™¾æ—¥ä¼ å¥‡"ç§°å· | è¿ç»­ç­¾åˆ°ç™¾æ—¥ |

### 2.2 å¯¹è¯ç±»æˆå°±
| æˆå°±ID | åç§° | æ¡ä»¶ | å¥–åŠ± | æè¿° |
|--------|------|------|------|------|
| chat_1 | åˆæ¬¡å¯¹è¯ | å¯¹è¯1æ¬¡ | 10ç§¯åˆ† | é¦–æ¬¡ä½¿ç”¨AIåŠ©æ‰‹ |
| chat_10 | ç§¯ææé—® | å¯¹è¯10æ¬¡ | 50ç§¯åˆ† + "å¯¹è¯æ–°æ‰‹"ç§°å· | å®Œæˆ10æ¬¡å¯¹è¯ |
| chat_50 | é˜²è¯ˆä¸“å®¶ | å¯¹è¯50æ¬¡ | 200ç§¯åˆ† + "å¯¹è¯è¾¾äºº"ç§°å· | å®Œæˆ50æ¬¡å¯¹è¯ |
| chat_100 | å¯¹è¯å¤§å¸ˆ | å¯¹è¯100æ¬¡ | 500ç§¯åˆ† + "å¯¹è¯å¤§å¸ˆ"ç§°å· | å®Œæˆ100æ¬¡å¯¹è¯ |

### 2.3 å­¦ä¹ ç±»æˆå°±
| æˆå°±ID | åç§° | æ¡ä»¶ | å¥–åŠ± | æè¿° |
|--------|------|------|------|------|
| read_1 | åˆæ¶‰åè¯ˆ | é˜…è¯»1ç¯‡ | 10ç§¯åˆ† | é¦–æ¬¡é˜…è¯»æ–‡ç«  |
| read_10 | æ±‚çŸ¥è‹¥æ¸´ | é˜…è¯»10ç¯‡ | 100ç§¯åˆ† + "æ±‚çŸ¥è€…"ç§°å· | é˜…è¯»10ç¯‡æ–‡ç«  |
| read_50 | åšè§ˆç¾¤ä¹¦ | é˜…è¯»50ç¯‡ | 500ç§¯åˆ† + "åšå­¦è€…"ç§°å· | é˜…è¯»50ç¯‡æ–‡ç«  |
| learn_7 | è‡ªå¾‹ä¹‹æ˜Ÿ | è¿ç»­å­¦ä¹ 7å¤© | 100ç§¯åˆ† + "è‡ªå¾‹ä¹‹æ˜Ÿ"ç§°å· | è¿ç»­7å¤©å­¦ä¹  |

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 achievements é›†åˆ
```javascript
{
  "_id": "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ",
  "achievementId": "æˆå°±å”¯ä¸€æ ‡è¯†",
  "name": "æˆå°±åç§°",
  "desc": "æˆå°±æè¿°",
  "icon": "æˆå°±å›¾æ ‡",
  "type": "sign|chat|read|learn", // æˆå°±ç±»å‹
  "target": 0, // è¾¾æˆæ¡ä»¶æ•°å€¼
  "points": 0, // å¥–åŠ±ç§¯åˆ†
  "rewardTitleId": "", // å¥–åŠ±ç§°å·ID
  "isActive": true, // æ˜¯å¦æ¿€æ´»
  "createdAt": "åˆ›å»ºæ—¶é—´"
}
```

### 3.2 user_achievements é›†åˆ
```javascript
{
  "_id": "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ",
  "_openid": "ç”¨æˆ·openid",
  "userId": "ç”¨æˆ·ID",
  "achievementId": "æˆå°±ID",
  "achievementName": "æˆå°±åç§°",
  "earnedAt": "è·å¾—æ—¶é—´",
  "rewardTitleId": "å¥–åŠ±ç§°å·ID",
  "pointsEarned": "è·å¾—ç§¯åˆ†"
}
```

## 4. äº‘å‡½æ•°å®ç°

### 4.1 checkAchievements äº‘å‡½æ•°
```javascript
// æ£€æŸ¥å¹¶æˆäºˆæˆå°±
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  const { action, count } = event // action: 'sign', 'chat', 'read', 'learn'
  
  try {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userResult = await db.collection('users')
      .where({ _openid: openid })
      .get()
    
    if (userResult.data.length === 0) {
      return { success: false, errMsg: 'ç”¨æˆ·ä¸å­˜åœ¨' }
    }
    
    const user = userResult.data[0]
    
    // è·å–å¯¹åº”ç±»å‹çš„æˆå°±
    const achievements = await db.collection('achievements')
      .where({
        type: action,
        target: _.lte(count), // ç›®æ ‡å€¼å°äºç­‰äºå½“å‰å€¼
        isActive: true
      })
      .get()
    
    const newAchievements = []
    const totalPoints = 0
    
    for (const achievement of achievements.data) {
      // æ£€æŸ¥æ˜¯å¦å·²è·å¾—
      const existed = await db.collection('user_achievements')
        .where({
          _openid: openid,
          achievementId: achievement.achievementId
        })
        .count()
      
      if (existed.total === 0) {
        // æˆäºˆæ–°æˆå°±
        await db.collection('user_achievements').add({
          data: {
            _openid: openid,
            userId: user._id,
            achievementId: achievement.achievementId,
            achievementName: achievement.name,
            earnedAt: new Date(),
            rewardTitleId: achievement.rewardTitleId,
            pointsEarned: achievement.points
          }
        })
        
        newAchievements.push(achievement)
        
        // æ·»åŠ ç§°å·åˆ°ç”¨æˆ·
        if (achievement.rewardTitleId) {
          await db.collection('users').doc(user._id).update({
            data: {
              titles: _.push(achievement.rewardTitleId)
            }
          })
        }
      }
    }
    
    // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
    if (newAchievements.length > 0) {
      const totalRewardPoints = newAchievements.reduce(
        (sum, ach) => sum + ach.points, 0
      )
      
      await db.collection('users').doc(user._id).update({
        data: {
          points: _.inc(totalRewardPoints)
        }
      })
    }
    
    return {
      success: true,
      data: {
        newAchievements,
        totalPoints: newAchievements.reduce((sum, ach) => sum + ach.points, 0)
      }
    }
  } catch (err) {
    return {
      success: false,
      errMsg: err.message
    }
  }
}
```

## 5. å‰ç«¯é¡µé¢é›†æˆ

### 5.1 æˆå°±é¡µé¢æ›´æ–°
```xml
<!-- achievements.wxml - å±•ç¤ºç§°å·å¥–åŠ± -->
<view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}">
  <!-- ... ç°æœ‰å†…å®¹ ... -->
  
  <!-- ç§°å·å¥–åŠ±å±•ç¤º -->
  <view wx:if="{{item.rewardTitleId}}" class="title-reward">
    <text class="reward-icon">ğŸ†</text>
    <text class="reward-text">å¥–åŠ±: {{item.rewardTitleName}}</text>
  </view>
</view>
```

### 5.2 æˆå°±è¿›åº¦è·Ÿè¸ª
```javascript
// achievements.js - å¢å¼ºæˆå°±æ£€æŸ¥é€»è¾‘
checkAchievements() {
  const { signDays, totalPoints, readArticles, chatTimes } = this.data
  
  // æ£€æŸ¥ç­¾åˆ°æˆå°±
  this.checkSingleTypeAchievements('sign', signDays)
  // æ£€æŸ¥å¯¹è¯æˆå°±
  this.checkSingleTypeAchievements('chat', chatTimes)
  // æ£€æŸ¥é˜…è¯»æˆå°±
  this.checkSingleTypeAchievements('read', readArticles)
}

checkSingleTypeAchievements(type, current) {
  const achievements = this.data.achievements.map(item => {
    if (item.type === type) {
      const unlocked = current >= item.target
      
      // å¦‚æœåˆšè§£é”ï¼Œæ˜¾ç¤ºæç¤ºå¹¶æˆäºˆç§°å·
      if (unlocked && !item.unlocked) {
        this.awardAchievementTitle(item)
      }
      
      return { ...item, current, unlocked }
    }
    return item
  })
  
  this.setData({ achievements })
}

// æˆäºˆç§°å·å¥–åŠ±
async awardAchievementTitle(achievement) {
  if (achievement.rewardTitleId) {
    try {
      // å°†ç§°å·æ·»åŠ åˆ°ç”¨æˆ·çš„ä½©æˆ´ç§°å·ä¸­
      const newEquippedTitles = [...this.data.equippedTitles, achievement.rewardTitleId]
      this.setData({ equippedTitles: newEquippedTitles })
      
      wx.showToast({
        title: `è·å¾—ç§°å·ï¼š${achievement.rewardTitleName}`,
        icon: 'none'
      })
    } catch (error) {
      console.error('æˆäºˆç§°å·å¤±è´¥ï¼š', error)
    }
  }
}
```

## 6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 6.1 æˆå°±è§£é”åŠ¨ç”»
```css
/* achievements.wxss - æ·»åŠ è§£é”åŠ¨ç”» */
.achievement-item.unlocked {
  animation: achievement-unlock 0.5s ease;
  border: 3rpx solid #10b981;
}

@keyframes achievement-unlock {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
```

### 6.2 ç§°å·å±•ç¤ºä¼˜åŒ–
- è§£é”æˆå°±æ—¶æ˜¾ç¤ºç§°å·è·å¾—åŠ¨ç”»
- åœ¨ç”¨æˆ·ä¸ªäººèµ„æ–™ä¸­å±•ç¤ºå½“å‰ä½©æˆ´ç§°å·
- æä¾›ç§°å·ç®¡ç†ç•Œé¢

## 7. æ•°æ®è¿½è¸ªä¸ç»Ÿè®¡

### 7.1 è¡Œä¸ºè¿½è¸ª
- ç­¾åˆ°è¡Œä¸ºï¼šåœ¨userSignInäº‘å‡½æ•°ä¸­è°ƒç”¨æˆå°±æ£€æŸ¥
- å¯¹è¯è¡Œä¸ºï¼šåœ¨aiChatäº‘å‡½æ•°ä¸­è°ƒç”¨æˆå°±æ£€æŸ¥
- é˜…è¯»è¡Œä¸ºï¼šåœ¨getArticleDetailäº‘å‡½æ•°ä¸­è°ƒç”¨æˆå°±æ£€æŸ¥
- å­¦ä¹ è¡Œä¸ºï¼šé€šè¿‡å­¦ä¹ æ—¶é—´ç»Ÿè®¡

### 7.2 ç»Ÿè®¡æŠ¥è¡¨
- ç”¨æˆ·æˆå°±å®Œæˆç‡
- ç§°å·è·å–åˆ†å¸ƒ
- ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿

## 8. æŠ€æœ¯å®ç°è¦ç‚¹

### 8.1 æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨æ•°æ®åº“ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- ç¼“å­˜å¸¸ç”¨æˆå°±æ•°æ®
- æ‰¹é‡å¤„ç†æˆå°±æˆäºˆ

### 8.2 æ•°æ®ä¸€è‡´æ€§
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ•°æ®å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

è¿™ä¸ªæˆå°±ç³»ç»Ÿè®¾è®¡ç¡®ä¿äº†ç”¨æˆ·è¡Œä¸ºèƒ½å¤Ÿè¢«å‡†ç¡®è¿½è¸ªï¼Œæˆå°±èƒ½å¤ŸåŠæ—¶æˆäºˆï¼Œå¹¶ä¸”ç”¨æˆ·å¯ä»¥è·å¾—ç›¸åº”çš„ç§°å·å¥–åŠ±ï¼Œä»è€Œæé«˜ç”¨æˆ·å‚ä¸åº¦å’Œå­¦ä¹ ç§¯ææ€§ã€‚