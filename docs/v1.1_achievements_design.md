# 反诈卫士小程序 v1.1 成就系统设计文档

## 1. 成就系统概述

成就系统是v1.1版本的核心功能之一，通过游戏化的方式激励用户参与反诈学习。系统将基于用户的签到、对话、学习行为自动解锁成就，并给予相应的称号奖励。

## 2. 成就分类设计

### 2.1 签到类成就
| 成就ID | 名称 | 条件 | 奖励 | 描述 |
|--------|------|------|------|------|
| sign_1 | 初次签到 | 签到1天 | 10积分 | 完成首次签到 |
| sign_7 | 坚持不懈 | 连续签到7天 | 50积分 + "七日勤勉"称号 | 连续签到一周 |
| sign_30 | 月度冠军 | 连续签到30天 | 200积分 + "签到大师"称号 | 连续签到一个月 |
| sign_100 | 百日传奇 | 连续签到100天 | 1000积分 + "百日传奇"称号 | 连续签到百日 |

### 2.2 对话类成就
| 成就ID | 名称 | 条件 | 奖励 | 描述 |
|--------|------|------|------|------|
| chat_1 | 初次对话 | 对话1次 | 10积分 | 首次使用AI助手 |
| chat_10 | 积极提问 | 对话10次 | 50积分 + "对话新手"称号 | 完成10次对话 |
| chat_50 | 防诈专家 | 对话50次 | 200积分 + "对话达人"称号 | 完成50次对话 |
| chat_100 | 对话大师 | 对话100次 | 500积分 + "对话大师"称号 | 完成100次对话 |

### 2.3 学习类成就
| 成就ID | 名称 | 条件 | 奖励 | 描述 |
|--------|------|------|------|------|
| read_1 | 初涉反诈 | 阅读1篇 | 10积分 | 首次阅读文章 |
| read_10 | 求知若渴 | 阅读10篇 | 100积分 + "求知者"称号 | 阅读10篇文章 |
| read_50 | 博览群书 | 阅读50篇 | 500积分 + "博学者"称号 | 阅读50篇文章 |
| learn_7 | 自律之星 | 连续学习7天 | 100积分 + "自律之星"称号 | 连续7天学习 |

## 3. 数据库设计

### 3.1 achievements 集合
```javascript
{
  "_id": "系统自动生成",
  "achievementId": "成就唯一标识",
  "name": "成就名称",
  "desc": "成就描述",
  "icon": "成就图标",
  "type": "sign|chat|read|learn", // 成就类型
  "target": 0, // 达成条件数值
  "points": 0, // 奖励积分
  "rewardTitleId": "", // 奖励称号ID
  "isActive": true, // 是否激活
  "createdAt": "创建时间"
}
```

### 3.2 user_achievements 集合
```javascript
{
  "_id": "系统自动生成",
  "_openid": "用户openid",
  "userId": "用户ID",
  "achievementId": "成就ID",
  "achievementName": "成就名称",
  "earnedAt": "获得时间",
  "rewardTitleId": "奖励称号ID",
  "pointsEarned": "获得积分"
}
```

## 4. 云函数实现

### 4.1 checkAchievements 云函数
```javascript
// 检查并授予成就
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  const { action, count } = event // action: 'sign', 'chat', 'read', 'learn'
  
  try {
    // 获取用户信息
    const userResult = await db.collection('users')
      .where({ _openid: openid })
      .get()
    
    if (userResult.data.length === 0) {
      return { success: false, errMsg: '用户不存在' }
    }
    
    const user = userResult.data[0]
    
    // 获取对应类型的成就
    const achievements = await db.collection('achievements')
      .where({
        type: action,
        target: _.lte(count), // 目标值小于等于当前值
        isActive: true
      })
      .get()
    
    const newAchievements = []
    const totalPoints = 0
    
    for (const achievement of achievements.data) {
      // 检查是否已获得
      const existed = await db.collection('user_achievements')
        .where({
          _openid: openid,
          achievementId: achievement.achievementId
        })
        .count()
      
      if (existed.total === 0) {
        // 授予新成就
        await db.collection('user_achievements').add({
          data: {
            _openid: openid,
            userId: user._id,
            achievementId: achievement.achievementId,
            achievementName: achievement.name,
            earnedAt: new Date(),
            rewardTitleId: achievement.rewardTitleId,
            pointsEarned: achievement.points
          }
        })
        
        newAchievements.push(achievement)
        
        // 添加称号到用户
        if (achievement.rewardTitleId) {
          await db.collection('users').doc(user._id).update({
            data: {
              titles: _.push(achievement.rewardTitleId)
            }
          })
        }
      }
    }
    
    // 更新用户积分
    if (newAchievements.length > 0) {
      const totalRewardPoints = newAchievements.reduce(
        (sum, ach) => sum + ach.points, 0
      )
      
      await db.collection('users').doc(user._id).update({
        data: {
          points: _.inc(totalRewardPoints)
        }
      })
    }
    
    return {
      success: true,
      data: {
        newAchievements,
        totalPoints: newAchievements.reduce((sum, ach) => sum + ach.points, 0)
      }
    }
  } catch (err) {
    return {
      success: false,
      errMsg: err.message
    }
  }
}
```

## 5. 前端页面集成

### 5.1 成就页面更新
```xml
<!-- achievements.wxml - 展示称号奖励 -->
<view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}">
  <!-- ... 现有内容 ... -->
  
  <!-- 称号奖励展示 -->
  <view wx:if="{{item.rewardTitleId}}" class="title-reward">
    <text class="reward-icon">🏆</text>
    <text class="reward-text">奖励: {{item.rewardTitleName}}</text>
  </view>
</view>
```

### 5.2 成就进度跟踪
```javascript
// achievements.js - 增强成就检查逻辑
checkAchievements() {
  const { signDays, totalPoints, readArticles, chatTimes } = this.data
  
  // 检查签到成就
  this.checkSingleTypeAchievements('sign', signDays)
  // 检查对话成就
  this.checkSingleTypeAchievements('chat', chatTimes)
  // 检查阅读成就
  this.checkSingleTypeAchievements('read', readArticles)
}

checkSingleTypeAchievements(type, current) {
  const achievements = this.data.achievements.map(item => {
    if (item.type === type) {
      const unlocked = current >= item.target
      
      // 如果刚解锁，显示提示并授予称号
      if (unlocked && !item.unlocked) {
        this.awardAchievementTitle(item)
      }
      
      return { ...item, current, unlocked }
    }
    return item
  })
  
  this.setData({ achievements })
}

// 授予称号奖励
async awardAchievementTitle(achievement) {
  if (achievement.rewardTitleId) {
    try {
      // 将称号添加到用户的佩戴称号中
      const newEquippedTitles = [...this.data.equippedTitles, achievement.rewardTitleId]
      this.setData({ equippedTitles: newEquippedTitles })
      
      wx.showToast({
        title: `获得称号：${achievement.rewardTitleName}`,
        icon: 'none'
      })
    } catch (error) {
      console.error('授予称号失败：', error)
    }
  }
}
```

## 6. 用户体验优化

### 6.1 成就解锁动画
```css
/* achievements.wxss - 添加解锁动画 */
.achievement-item.unlocked {
  animation: achievement-unlock 0.5s ease;
  border: 3rpx solid #10b981;
}

@keyframes achievement-unlock {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
```

### 6.2 称号展示优化
- 解锁成就时显示称号获得动画
- 在用户个人资料中展示当前佩戴称号
- 提供称号管理界面

## 7. 数据追踪与统计

### 7.1 行为追踪
- 签到行为：在userSignIn云函数中调用成就检查
- 对话行为：在aiChat云函数中调用成就检查
- 阅读行为：在getArticleDetail云函数中调用成就检查
- 学习行为：通过学习时间统计

### 7.2 统计报表
- 用户成就完成率
- 称号获取分布
- 用户活跃度趋势

## 8. 技术实现要点

### 8.1 性能优化
- 使用数据库索引加速查询
- 缓存常用成就数据
- 批量处理成就授予

### 8.2 数据一致性
- 使用事务确保数据一致性
- 错误处理和重试机制
- 数据备份和恢复策略

### 8.3 调试与监控
- 在关键数据流转点添加console.log调试日志
- chat.js中记录actionData的接收和处理过程
- achievements.js中记录用户数据加载和成就检查过程
- 便于排查数据同步问题

### 8.4 已知问题修复记录

#### 问题：AI对话后成就页面不更新
**问题描述**：用户完成AI对话后，学习记录页面更新，但成就页面不更新。

**原因分析**：
1. 数据流检查发现chat.js正确接收和处理actionData
2. 成就页面在onShow时正确调用loadUserData和checkAchievements
3. 需要添加调试日志以追踪实际运行时的数据状态

**修复措施**：
1. 在chat.js中添加详细的console.log日志，记录actionData的接收、解析和存储过程
2. 在achievements.js中添加调试日志，记录onLoad/onShow触发、用户数据加载和成就检查过程
3. 确保数据从云函数→前端→本地存储→成就页面的完整流转可追踪

**调试日志位置**：
- `pages/chat/chat.js:134-160` - 记录AI对话成功后的数据处理
- `pages/achievements/achievements.js:202-211` - 记录页面生命周期触发
- `pages/achievements/achievements.js:214-230` - 记录用户数据加载
- `pages/achievements/achievements.js:233-280` - 记录成就状态检查

#### 问题：学习记录显示对话但初次对话成就未达成
**问题描述**：学习记录页面显示有一次AI对话记录，但"初次对话"成就（chat_1）未达成。

**原因分析**：
1. **数据源不一致**：学习记录页面从`chat_messages`本地存储计算对话次数（`Math.floor(chatMessages.length / 2)`），而成就页面从`chatTimes`本地存储读取
2. **数据库成就数据缺失**：数据库中可能没有初始化成就数据，导致trackAction云函数无法检查和授予成就
3. **云函数返回数据异常**：trackAction云函数可能返回异常或actionData为空

**修复措施**：

1. **创建成就初始化云函数** (`cloudfunctions/initAchievements/index.js`)
   - 初始化所有成就数据到数据库achievements集合
   - 包含签到、阅读、对话、积分、学习等5类共16个成就
   - 避免重复初始化，已存在数据时跳过

2. **修复学习记录页面数据源** (`pages/learning/learning.js:28-54`)
   - 优先使用`chatTimes`数据源（与成就页面保持一致）
   - 如果`chatTimes`为0，则从`chat_messages`计算作为备用
   - 添加调试日志记录数据加载过程

3. **增强chat.js数据同步** (`pages/chat/chat.js:132-180`)
   - 添加备用逻辑：当actionData.updatedCount不是数字时，手动更新本地chatTimes
   - 添加备用逻辑：当actionData为空时，手动更新chatTimes和points
   - 确保即使云函数异常，本地数据也能正确更新

**关键代码位置**：
- `cloudfunctions/initAchievements/index.js` - 成就初始化云函数
- `pages/learning/learning.js:28-54` - 学习数据加载逻辑
- `pages/chat/chat.js:140-180` - 对话数据更新和备用逻辑

**使用说明**：
1. 部署initAchievements云函数并调用一次，初始化成就数据
2. 用户进行AI对话时，trackAction云函数会自动检查并授予成就
3. 学习记录和成就页面现在使用统一的数据源，确保数据一致性

#### 问题：获得成就积分没有相应增加
**问题描述**：用户获得成就时，积分没有相应增加。

**原因分析**：
1. 缺少详细的调试日志，无法追踪积分计算和更新过程
2. 可能存在数据库更新失败的情况但没有错误提示
3. 前端可能没有正确处理actionData中的积分信息

**修复措施**：

1. **增强trackAction云函数调试日志** (`cloudfunctions/trackAction/index.js`)
   - 在成就查询阶段记录查询条件和结果数量
   - 在成就授予阶段记录每个成就的检查和授予过程
   - 在积分计算阶段记录基础积分、成就积分和总积分
   - 在数据库更新阶段记录更新对象和更新结果
   - 在返回数据阶段记录完整的返回值

2. **增强前端积分更新日志** (`pages/chat/chat.js` 和 `pages/article-detail/article-detail.js`)
   - 在处理actionData前记录当前本地积分
   - 在更新积分后记录新的积分值
   - 当actionData中没有积分信息时发出警告
   - 确保备用逻辑也能正确更新积分

3. **积分获取途径全面排查**
   
   **已验证的积分获取途径：**
   
   - **AI对话** (`pages/chat/chat.js:132-195`)
     - 基础积分：每次对话+2积分
     - 成就积分：初次对话+10积分，积极提问+50积分，防诈专家+200积分
     - 数据源：trackAction云函数返回的actionData
   
   - **阅读文章** (`pages/article-detail/article-detail.js:238-270`)
     - 基础积分：每篇文章+5积分
     - 成就积分：求知若渴+10积分，博览群书+100积分，反诈达人+500积分
     - 数据源：trackAction云函数返回的actionData
   
   - **签到** (`pages/sign-in/sign-in.js:171-184`)
     - 基础积分：每次签到+10积分
     - 成就积分：初来乍到+10积分，坚持不懈+50积分等
     - 数据源：userSignIn云函数返回的data
   
   - **绑定学生** (`cloudfunctions/bindStudent/index.js:127`)
     - 奖励积分：绑定成功+50积分
     - 数据源：bindStudent云函数直接更新数据库
   
   - **积分兑换** (`cloudfunctions/redeemTitle/index.js:64`)
     - 扣除积分：兑换称号时扣除相应积分
     - 数据源：redeemTitle云函数直接更新数据库

**调试日志位置**：
- `cloudfunctions/trackAction/index.js:97-106` - 成就查询日志
- `cloudfunctions/trackAction/index.js:111-145` - 成就授予日志
- `cloudfunctions/trackAction/index.js:147-173` - 积分计算和更新日志
- `pages/chat/chat.js:135-195` - 对话积分更新日志
- `pages/article-detail/article-detail.js:238-270` - 阅读积分更新日志

**积分计算公式**：
```
总积分 = 基础积分 + 成就积分
基础积分 = chat: 2, read: 5
成就积分 = 所有新成就的points字段之和
```

**数据流验证**：
1. 用户行为（对话/阅读）→ 前端调用trackAction
2. trackAction计算积分并更新数据库
3. trackAction返回actionData（包含userPoints和totalPoints）
4. 前端接收actionData并更新本地存储
5. 各页面从云端数据库读取并显示积分

#### 问题：绑定学号后积分没有增加，重新编译后积分清零
**问题描述**：
1. 绑定学号成功后，积分没有相应增加
2. 重新编译小程序后，积分清零
3. 用户数据（积分、成就、称号、头像、昵称）主要存储在本地

**根本原因**：
- 用户数据主要存储在本地存储（wx.setStorageSync）
- 云端数据库更新后，前端没有及时同步更新本地存储
- 本地存储在重新编译或清除缓存后会丢失

**解决方案**：

1. **创建getUserInfo云函数** (`cloudfunctions/getUserInfo/index.js`)
   - 从云端数据库获取用户完整信息
   - 包括积分、签到天数、对话次数、阅读次数、成就列表、称号列表等
   - 聚合user_achievements集合的成就详情

2. **修改各页面数据加载逻辑**
   - 用户页面：`onShow()` 调用 `loadUserDataFromCloud()`
   - 积分页面：`onShow()` 调用 `loadUserPointsFromCloud()`
   - 成就页面：`onLoad()` 和 `onShow()` 调用 `loadUserDataFromCloud()`
   - 学习记录页面：`onShow()` 调用 `loadLearningDataFromCloud()`
   - 签到页面：`onShow()` 调用 `refreshStateFromCloud()`
   - 所有页面都采用云端优先策略，失败时降级到本地存储

3. **修复绑定学号页面** (`pages/bind-student/bind-student.js:145-165`)
   - 绑定成功后更新本地存储的积分和用户信息
   - 确保前端显示与云端数据一致

**架构改进原则**：
- 数据源统一：所有用户数据以云端数据库为准
- 本地存储为缓存：本地存储仅作为缓存，提升访问速度
- 云端优先策略：页面加载时优先从云端获取最新数据
- 降级机制：云端请求失败时降级到本地存储

**数据存储架构**：
- 云端数据库（主数据源）：users集合存储用户完整信息
- 本地存储（缓存）：缓存常用数据，提升访问速度

**详细文档**：参见 `docs/user_data_architecture.md`

这个成就系统设计确保了用户行为能够被准确追踪，成就能够及时授予，并且用户可以获得相应的称号奖励，从而提高用户参与度和学习积极性。