# 反诈卫士小程序 v1.1 部署计划

## 1. 部署前准备

### 1.1 环境检查
- [ ] 确认云开发环境ID配置正确
- [ ] 确认云开发配额充足
- [ ] 检查服务器资源使用情况
- [ ] 备份当前数据库

### 1.2 代码审核
- [ ] 完成代码审查
- [ ] 确认所有功能按设计实现
- [ ] 完成单元测试
- [ ] 完成集成测试

## 2. 数据库迁移

### 2.1 创建新集合
```javascript
// 创建titles集合
db.createCollection('titles')

// 为users集合添加新字段
db.users.updateMany(
  {},
  {
    $set: {
      titles: [],
      equippedTitles: [],
      continuousLearnDays: 0,
      lastLearnDate: null,
      totalReadCount: 0,
      totalChatCount: 0,
      lastChatDate: null,
      lastReadDate: null
    }
  }
)

// 创建索引
db.users.createIndex({ _openid: 1 })
db.titles.createIndex({ titleId: 1, isActive: 1 })
db.user_achievements.createIndex({ _openid: 1, achievementId: 1 })
```

### 2.2 初始化数据
```javascript
// 初始化称号数据
const initialTitles = [
  {
    titleId: "anti_fraud_pioneer",
    name: "反诈先锋",
    desc: "致力于反诈骗事业",
    icon: "🔥",
    type: "redeem",
    rarity: "rare",
    points: 100,
    isActive: true,
    createdAt: new Date()
  },
  {
    titleId: "chat_expert_10",
    name: "对话新手",
    desc: "完成10次对话",
    icon: "🗨️",
    type: "achievement",
    rarity: "common",
    achievementId: "chat_10",
    isActive: true,
    createdAt: new Date()
  },
  // 添加其他初始称号
]

// 批量插入称号数据
db.titles.insertMany(initialTitles)
```

## 3. 云函数部署

### 3.1 新增云函数
- [ ] getTitles - 获取称号列表
- [ ] redeemTitle - 积分兑换称号
- [ ] equipTitle - 佩戴/卸下称号
- [ ] trackAction - 追踪用户行为
- [ ] getUserTitles - 获取用户称号信息

### 3.2 更新云函数
- [ ] login - 添加称号字段初始化
- [ ] userSignIn - 增强成就检查
- [ ] aiChat - 调用行为追踪
- [ ] getArticleDetail - 调用行为追踪

### 3.3 部署步骤
```bash
# 1. 上传并部署新增云函数
cd cloudfunctions/getTitles
npm install
# 上传到云端

cd ../redeemTitle
npm install
# 上传到云端

cd ../equipTitle
npm install
# 上传到云端

# 2. 更新现有云函数
cd ../login
npm install
# 上传到云端

# 重复上述步骤直到所有云函数都更新完成
```

## 4. 前端页面部署

### 4.1 页面更新
- [ ] 更新用户管理页面 (pages/user/user)
- [ ] 创建称号管理页面 (pages/title-management/title-management)
- [ ] 更新成就页面 (pages/achievements/achievements)
- [ ] 更新积分商城页面 (pages/points/points)

### 4.2 配置文件更新
- [ ] 更新 app.json 添加新页面路径
- [ ] 确认权限配置正确

## 5. 测试计划

### 5.1 功能测试
#### 用户管理功能
- [ ] 验证称号展示功能
- [ ] 测试称号佩戴功能
- [ ] 确认称号切换功能

#### 成就系统功能
- [ ] 测试签到成就解锁
- [ ] 测试对话成就解锁
- [ ] 测试阅读成就解锁
- [ ] 验证称号自动授予

#### 积分商城功能
- [ ] 测试称号兑换功能
- [ ] 验证积分扣除逻辑
- [ ] 确认兑换记录更新

### 5.2 性能测试
- [ ] 云函数响应时间 < 3秒
- [ ] 页面加载时间 < 5秒
- [ ] 数据库查询时间 < 1秒
- [ ] 并发用户压力测试

### 5.3 兼容性测试
- [ ] 微信小程序基础库兼容性
- [ ] 不同设备屏幕适配
- [ ] 网络环境适应性

### 5.4 安全测试
- [ ] 数据访问权限验证
- [ ] 输入参数安全验证
- [ ] API调用频率限制

## 6. 发布计划

### 6.1 灰度发布
- [ ] 选择10%用户进行灰度测试
- [ ] 监控系统稳定性指标
- [ ] 收集用户反馈
- [ ] 修复发现的问题

### 6.2 全量发布
- [ ] 确认灰度测试无重大问题
- [ ] 执行全量发布
- [ ] 监控系统性能指标
- [ ] 准备应急回滚方案

## 7. 监控与维护

### 7.1 系统监控
- [ ] 云函数调用成功率 > 99%
- [ ] 数据库连接稳定性
- [ ] 用户活跃度指标
- [ ] 称号获取率统计

### 7.2 数据分析
- [ ] 功能使用率统计
- [ ] 用户留存率分析
- [ ] 成就完成率统计
- [ ] 称号兑换率分析

## 8. 应急预案

### 8.1 回滚方案
- [ ] 数据库备份恢复方案
- [ ] 云函数版本回退方案
- [ ] 前端代码回退方案

### 8.2 问题处理
- [ ] 严重问题2小时内解决
- [ ] 一般问题24小时内解决
- [ ] 用户反馈48小时内响应

## 9. 上线检查清单

### 9.1 功能检查
- [ ] 成就系统正常工作
- [ ] 称号系统正常工作
- [ ] 积分商城正常工作
- [ ] 用户管理正常工作

### 9.2 性能检查
- [ ] 页面响应时间达标
- [ ] 云函数性能达标
- [ ] 数据库查询效率达标

### 9.3 安全检查
- [ ] 数据安全性验证
- [ ] 权限控制验证
- [ ] API安全验证

## 10. 发布后验证

### 10.1 功能验证
- [ ] 用户可以正常签到并获得成就
- [ ] 用户可以兑换称号
- [ ] 用户可以管理称号
- [ ] 所有数据统计准确

### 10.2 用户体验验证
- [ ] 界面交互流畅
- [ ] 功能操作便捷
- [ ] 反馈及时准确

### 10.3 数据验证
- [ ] 用户数据完整
- [ ] 称号数据准确
- [ ] 积分数据准确

此部署计划确保v1.1版本能够安全、稳定地发布上线，并为用户提供优质的使用体验。