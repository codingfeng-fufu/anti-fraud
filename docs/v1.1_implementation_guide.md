# åè¯ˆå«å£«å°ç¨‹åº v1.1 å®ç°æŒ‡å—

## æ¦‚è¿°
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†v1.1ç‰ˆæœ¬ä¸­ç”¨æˆ·ç®¡ç†ã€æˆå°±ç³»ç»Ÿã€ç§¯åˆ†å•†åŸçš„å®Œæ•´å®ç°æ–¹æ¡ˆã€‚

## 1. æ•°æ®åº“ç»“æ„æ›´æ–°

### 1.1 titles é›†åˆç»“æ„
```javascript
{
  "_id": "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ",
  "titleId": "ç§°å·å”¯ä¸€æ ‡è¯†",
  "name": "ç§°å·åç§°",
  "desc": "ç§°å·æè¿°",
  "icon": "ç§°å·å›¾æ ‡",
  "type": "achievement|redeem", // achievement: æˆå°±å¥–åŠ±, redeem: ç§¯åˆ†å…‘æ¢
  "rarity": "common|rare|epic", // ç¨€æœ‰åº¦
  "condition": {}, // è·å¾—æ¡ä»¶ï¼ˆæˆå°±ç±»å‹ï¼‰
  "points": 0, // å…‘æ¢æ‰€éœ€ç§¯åˆ†ï¼ˆredeemç±»å‹ï¼‰
  "achievementId": "", // å…³è”æˆå°±IDï¼ˆachievementç±»å‹ï¼‰
  "isActive": true,
  "createdAt": "åˆ›å»ºæ—¶é—´"
}
```

### 1.2 users é›†åˆæ–°å¢å­—æ®µ
```javascript
{
  // ... ç°æœ‰å­—æ®µ
  "titles": [], // å·²è·å¾—çš„ç§°å·IDæ•°ç»„
  "equippedTitles": [], // å½“å‰ä½©æˆ´çš„ç§°å·IDæ•°ç»„
  "continuousLearnDays": 0, // è¿ç»­å­¦ä¹ å¤©æ•°
  "lastLearnDate": null, // æœ€åå­¦ä¹ æ—¥æœŸ
  "totalReadCount": 0, // æ€»é˜…è¯»æ–‡ç« æ•°
  "totalChatCount": 0, // æ€»å¯¹è¯æ¬¡æ•°
  "lastChatDate": null, // æœ€åå¯¹è¯æ—¥æœŸ
  "lastReadDate": null // æœ€åé˜…è¯»æ—¥æœŸ
}
```

## 2. äº‘å‡½æ•°å®ç°

### 2.1 getTitles äº‘å‡½æ•°
```javascript
// è·å–ç§°å·åˆ—è¡¨
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  try {
    // è·å–æ‰€æœ‰æ¿€æ´»çš„ç§°å·
    const allTitles = await db.collection('titles')
      .where({ isActive: true })
      .orderBy('points', 'asc')
      .get()
    
    // è·å–ç”¨æˆ·å·²è·å¾—çš„ç§°å·
    const userResult = await db.collection('users')
      .where({ _openid: openid })
      .get()
    
    const userTitles = userResult.data[0]?.titles || []
    
    // åŒºåˆ†å¯å…‘æ¢å’Œå·²è·å¾—çš„ç§°å·
    const titles = allTitles.data.map(title => ({
      ...title,
      owned: userTitles.includes(title.titleId),
      canRedeem: title.type === 'redeem' && !userTitles.includes(title.titleId)
    }))
    
    return {
      success: true,
      data: { titles }
    }
  } catch (err) {
    return {
      success: false,
      errMsg: err.message
    }
  }
}
```

### 2.2 redeemTitle äº‘å‡½æ•°
```javascript
// ç§¯åˆ†å…‘æ¢ç§°å·
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  const { titleId } = event
  
  try {
    // è·å–ç§°å·ä¿¡æ¯
    const titleResult = await db.collection('titles')
      .where({ titleId, isActive: true })
      .get()
    
    if (titleResult.data.length === 0) {
      return {
        success: false,
        errMsg: 'ç§°å·ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶'
      }
    }
    
    const title = titleResult.data[0]
    
    if (title.type !== 'redeem') {
      return {
        success: false,
        errMsg: 'è¯¥ç§°å·æ— æ³•å…‘æ¢'
      }
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userResult = await db.collection('users')
      .where({ _openid: openid })
      .get()
    
    if (userResult.data.length === 0) {
      return {
        success: false,
        errMsg: 'ç”¨æˆ·ä¸å­˜åœ¨'
      }
    }
    
    const user = userResult.data[0]
    
    // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    if (user.points < title.points) {
      return {
        success: false,
        errMsg: `ç§¯åˆ†ä¸è¶³ï¼Œéœ€è¦${title.points}ç§¯åˆ†ï¼Œå½“å‰${user.points}ç§¯åˆ†`
      }
    }
    
    // æ‰£é™¤ç§¯åˆ†å¹¶æ·»åŠ ç§°å·
    await db.collection('users').doc(user._id).update({
      data: {
        points: _.inc(-title.points),
        titles: _.push(title.titleId)
      }
    })
    
    return {
      success: true,
      message: `æˆåŠŸå…‘æ¢ç§°å·ï¼š${title.name}`
    }
  } catch (err) {
    return {
      success: false,
      errMsg: err.message
    }
  }
}
```

## 3. å‰ç«¯é¡µé¢å®ç°

### 3.1 ç”¨æˆ·ç®¡ç†é¡µé¢

#### user.wxml æ›´æ–°
```xml
<!-- ç”¨æˆ·ç®¡ç†é¡µé¢ - æ·»åŠ ç§°å·å±•ç¤º -->
<view class="user-container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ -->
  <view class="user-header">
    <!-- ... ç°æœ‰å†…å®¹ ... -->
    
    <!-- ç§°å·å±•ç¤ºåŒºåŸŸ -->
    <view class="title-display" bindtap="showTitleManagement">
      <text class="title-label">å½“å‰ç§°å·:</text>
      <view class="current-titles">
        <text wx:for="{{equippedTitles}}" wx:key="id" class="title-tag">
          {{item.name}}
        </text>
        <text wx:if="{{equippedTitles.length === 0}}" class="no-title">æš‚æ— ç§°å·</text>
      </view>
    </view>
  </view>
  
  <!-- ... ç°æœ‰å†…å®¹ ... -->
</view>
```

#### user.js æ›´æ–°
```javascript
// ç”¨æˆ·ç®¡ç†é¡µé¢é€»è¾‘æ›´æ–°
Page({
  data: {
    // ... ç°æœ‰æ•°æ® ...
    equippedTitles: [], // å½“å‰ä½©æˆ´çš„ç§°å·
    allTitles: []       // ç”¨æˆ·æ‰€æœ‰ç§°å·
  },

  onLoad() {
    // ... ç°æœ‰é€»è¾‘ ...
    this.loadUserTitles()
  },

  // åŠ è½½ç”¨æˆ·ç§°å·
  async loadUserTitles() {
    try {
      const result = await wx.cloud.callFunction({
        name: 'getUserTitles',
        data: {}
      })

      if (result.result.success) {
        this.setData({
          equippedTitles: result.result.data.equippedTitles || [],
          allTitles: result.result.data.allTitles || []
        })
      }
    } catch (err) {
      console.error('åŠ è½½ç”¨æˆ·ç§°å·å¤±è´¥ï¼š', err)
    }
  },

  // æ˜¾ç¤ºç§°å·ç®¡ç†
  showTitleManagement() {
    wx.navigateTo({
      url: '/pages/title-management/title-management'
    })
  }
})
```

### 3.2 ç§°å·ç®¡ç†é¡µé¢

#### title-management.wxml
```xml
<view class="title-management-container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="page-header">
    <view class="header-left" bindtap="goBack">
      <text class="back-icon">â€¹</text>
    </view>
    <view class="header-title">ç§°å·ç®¡ç†</view>
    <view class="header-right"></view>
  </view>

  <!-- å½“å‰ä½©æˆ´ç§°å· -->
  <view class="current-titles-section">
    <view class="section-title">å½“å‰ä½©æˆ´ç§°å·</view>
    <view class="equipped-titles">
      <view wx:for="{{equippedTitles}}" wx:key="id" class="title-item equipped">
        <text class="title-icon">{{item.icon}}</text>
        <text class="title-name">{{item.name}}</text>
        <button class="unequip-btn" bindtap="unequipTitle" data-id="{{item.titleId}}">
          å¸ä¸‹
        </button>
      </view>
      <view wx:if="{{equippedTitles.length === 0}}" class="no-equipped">
        æš‚æœªä½©æˆ´ä»»ä½•ç§°å·
      </view>
    </view>
  </view>

  <!-- å¯ä½©æˆ´ç§°å· -->
  <view class="available-titles-section">
    <view class="section-title">å¯ä½©æˆ´ç§°å· (æœ€å¤š3ä¸ª)</view>
    <view class="available-titles">
      <view wx:for="{{ownedTitles}}" wx:key="id" class="title-item available">
        <text class="title-icon">{{item.icon}}</text>
        <text class="title-name">{{item.name}}</text>
        <text class="title-rarity {{item.rarity}}">{{item.rarity}}</text>
        <button wx:if="{{!isEquipped(item.titleId)}}" 
                class="equip-btn" 
                bindtap="equipTitle" 
                data-id="{{item.titleId}}"
                disabled="{{equippedTitles.length >= 3}}">
          ä½©æˆ´
        </button>
        <button wx:else class="equipped-btn" disabled>å·²ä½©æˆ´</button>
      </view>
    </view>
  </view>

  <!-- å·²è·å¾—ç§°å·ç»Ÿè®¡ -->
  <view class="title-stats">
    <view class="stat-item">
      <text class="stat-number">{{ownedTitles.length}}</text>
      <text class="stat-label">å·²è·å¾—</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{equippedTitles.length}}</text>
      <text class="stat-label">å·²ä½©æˆ´</text>
    </view>
  </view>
</view>
```

### 3.3 ç§¯åˆ†å•†åŸæ›´æ–°

#### points.wxml æ›´æ–° - æ·»åŠ ç§°å·å…‘æ¢ä¸“åŒº
```xml
<!-- ç§¯åˆ†å•†åŸé¡µé¢ - æ·»åŠ ç§°å·å…‘æ¢ä¸“åŒº -->
<view class="points-container">
  <!-- ... ç°æœ‰å†…å®¹ ... -->

  <!-- ç§°å·å…‘æ¢ä¸“åŒº -->
  <view class="title-exchange-section">
    <view class="section-title">ç§°å·å…‘æ¢</view>
    <view class="title-products">
      <view wx:for="{{titleProducts}}" wx:key="id" class="title-product-item">
        <view class="title-icon">{{item.icon}}</view>
        <view class="title-content">
          <view class="title-name">{{item.name}}</view>
          <view class="title-desc">{{item.desc}}</view>
          <view class="title-rarity {{item.rarity}}">{{item.rarity}}</view>
        </view>
        <button class="exchange-btn {{userPoints < item.points ? 'disabled' : ''}}"
                bindtap="exchangeTitle"
                data-id="{{item.titleId}}"
                disabled="{{userPoints < item.points || item.owned}}">
          {{item.owned ? 'å·²è·å¾—' : userPoints < item.points ? 'ç§¯åˆ†ä¸è¶³' : 'å…‘æ¢'}}
        </button>
      </view>
    </view>
  </view>

  <!-- ... ç°æœ‰å†…å®¹ ... -->
</view>
```

## 4. å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šæ•°æ®åº“å‡†å¤‡
1. åˆ›å»º `titles` é›†åˆ
2. ä¸º `users` é›†åˆæ·»åŠ æ–°å­—æ®µ
3. åˆå§‹åŒ–é»˜è®¤ç§°å·æ•°æ®

### æ­¥éª¤2ï¼šäº‘å‡½æ•°å¼€å‘
1. å®ç° `getTitles` äº‘å‡½æ•°
2. å®ç° `redeemTitle` äº‘å‡½æ•°
3. å®ç° `equipTitle` äº‘å‡½æ•°
4. å®ç° `getUserTitles` äº‘å‡½æ•°

### æ­¥éª¤3ï¼šå‰ç«¯é¡µé¢å¼€å‘
1. æ›´æ–°ç”¨æˆ·ç®¡ç†é¡µé¢
2. åˆ›å»ºç§°å·ç®¡ç†é¡µé¢
3. æ›´æ–°ç§¯åˆ†å•†åŸé¡µé¢
4. åˆ›å»ºæˆå°±é¡µé¢ä¼˜åŒ–

### æ­¥éª¤4ï¼šæµ‹è¯•ä¸éƒ¨ç½²
1. åŠŸèƒ½æµ‹è¯•
2. ç”¨æˆ·ä½“éªŒæµ‹è¯•
3. æ€§èƒ½ä¼˜åŒ–
4. æ­£å¼éƒ¨ç½²

## 5. æ•°æ®åˆå§‹åŒ–è„šæœ¬

### åˆå§‹åŒ–ç§°å·æ•°æ®
```javascript
// åˆå§‹åŒ–ç§°å·æ•°æ®çš„äº‘å‡½æ•°
const titlesData = [
  {
    titleId: "anti_fraud_pioneer",
    name: "åè¯ˆå…ˆé”‹",
    desc: "è‡´åŠ›äºåè¯ˆéª—äº‹ä¸š",
    icon: "ğŸ”¥",
    type: "redeem",
    rarity: "rare",
    points: 100,
    isActive: true
  },
  {
    titleId: "chat_expert_10",
    name: "å¯¹è¯æ–°æ‰‹",
    desc: "å®Œæˆ10æ¬¡å¯¹è¯",
    icon: "ğŸ—¨ï¸",
    type: "achievement",
    rarity: "common",
    achievementId: "chat_10",
    isActive: true
  },
  // ... æ›´å¤šç§°å·æ•°æ®
]

// æ‰¹é‡æ·»åŠ ç§°å·æ•°æ®
exports.main = async (event, context) => {
  const db = cloud.database()
  
  try {
    for (const title of titlesData) {
      await db.collection('titles').add({
        data: title
      })
    }
    
    return {
      success: true,
      message: "ç§°å·æ•°æ®åˆå§‹åŒ–å®Œæˆ"
    }
  } catch (err) {
    return {
      success: false,
      errMsg: err.message
    }
  }
}
```

æ­¤å®ç°æŒ‡å—æä¾›äº†å®Œæ•´çš„v1.1ç‰ˆæœ¬å¼€å‘æ–¹æ¡ˆï¼Œæ¶µç›–äº†æ•°æ®åº“è®¾è®¡ã€äº‘å‡½æ•°å®ç°ã€å‰ç«¯é¡µé¢æ›´æ–°ç­‰æ‰€æœ‰å¿…è¦ç»„ä»¶ã€‚