# AI 图片识别功能实现说明

## 需求概述
在现有的 AI 聊天功能基础上，添加**真正的图片识别功能**，让用户可以上传诈骗信息截图，AI 自动分析图片内容并识别诈骗风险。

## 已完成的改动

### 1. 前端改动（pages/chat/）

#### chat.js
- **修改 `uploadImage()` 函数**：实现真正的图片选择和上传
  - 调用 `wx.chooseImage()` 让用户选择图片
  - 使用 `wx.getFileSystemManager().readFile()` 将图片转为 **base64** 格式
  - 将 base64 图片数据传给云函数
  - 在消息列表中显示用户上传的图片

#### chat.wxml
- 添加图片显示支持：`<image>` 标签显示用户上传的图片

#### chat.wxss
- 添加 `.message-image` 样式，让图片在聊天界面中美观显示

### 2. 后端改动（cloudfunctions/aiChat/index.js）

#### 主函数修改
- 接收 `imageBase64` 参数（前端传来的 base64 图片）
- 判断如果有图片，调用 `generateReplyWithVision()` 多模态函数

#### 新增函数：`generateReplyWithVision()`
这是核心功能，调用**通义千问 VL（Qwen-VL）多模态模型**：

```javascript
// API 端点
https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation

// 模型
qwen-vl-max  // 支持图片+文字输入

// 请求格式
{
  model: 'qwen-vl-max',
  input: {
    messages: [
      {
        role: 'user',
        content: [
          { type: 'image', image: 'data:image/jpeg;base64,xxx' },
          { type: 'text', text: '请分析这张图片' }
        ]
      }
    ]
  }
}
```

## 技术要点

### 图片转 base64
```javascript
wx.getFileSystemManager().readFile({
  filePath: tempFilePath,
  encoding: 'base64',
  success: (fileRes) => {
    const base64Image = fileRes.data  // 这就是 base64 字符串
  }
})
```

### 多模态 API 调用
- **模型**：`qwen-vl-max`（通义千问视觉大模型）
- **输入格式**：支持图片（base64）+ 文字混合输入
- **超时时间**：25秒（图片分析比纯文字慢）

### 系统提示词
专门为图片分析设计的 prompt：
- 识别图片中的文字、对话、界面
- 分析诈骗特征（刷单、投资、网购退款等）
- 给出风险评估（高/中/低）
- 提供防范建议

## 使用流程

1. 用户点击📷按钮
2. 选择图片（相册或拍照）
3. 前端将图片转为 base64
4. 发送到云函数 `aiChat`
5. 云函数调用 Qwen-VL API
6. AI 分析图片内容
7. 返回分析结果给用户

## API 配置

确保在 `cloudfunctions/aiChat/index.js` 中配置了有效的 API Key：

```javascript
const QWEN_API_KEY = 'sk-xxxxxxxxxx'  // 你的通义千问 API Key
```

**注意**：Qwen-VL 多模态模型可能需要单独开通权限，请在阿里云控制台确认。

## 测试建议

1. **测试图片上传**：选择图片后是否正常显示
2. **测试 base64 转换**：检查控制台日志，确认 base64 数据正确
3. **测试 API 调用**：上传一张诈骗截图，看 AI 是否能正确识别
4. **测试错误处理**：网络断开或 API 失败时，是否有友好提示

## 可能的问题

### 1. API 权限问题
如果 Qwen-VL 模型未开通，会返回错误。解决方案：
- 登录阿里云控制台
- 开通"通义千问 VL"多模态服务

### 2. 图片太大
微信小程序对图片大小有限制。解决方案：
- 使用 `sizeType: ['compressed']` 压缩图片
- 或在前端限制图片大小（如 < 2MB）

### 3. 超时问题
图片分析比文字慢。解决方案：
- 已设置 25 秒超时
- 如果还不够，可以调整云函数超时配置

## 参考资料

- [通义千问 API 文档](https://help.aliyun.com/zh/dashscope/)
- [Qwen-VL 多模态模型文档](https://help.aliyun.com/zh/dashscope/developer-reference/qwen-vl-api)
- [微信小程序图片处理](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html)

## 下一步优化

1. **支持多张图片**：一次上传多张截图
2. **OCR 文字提取**：先提取图片文字，再分析
3. **图片缓存**：避免重复上传相同图片
4. **结果可视化**：用高亮标注图片中的可疑部分

---

**总结**：现在 AI 聊天功能已经支持真正的图片识别了！用户可以上传诈骗截图，AI 会自动分析并给出风险评估。
