# 快速修复指南

## 🚨 问题

小程序无法从云数据库加载文章。

## ✅ 解决方案（3分钟搞定）

### Step 1: 修改数据库权限（最重要）

#### 方法 A：Web 控制台（推荐）⭐

1. **打开浏览器**
   ```
   https://console.cloud.tencent.com/tcb
   ```

2. **登录并选择环境**
   ```
   扫码登录 → 选择：cloud1-9g3v8lt8fb0108e7
   ```

3. **进入数据库**
   ```
   左侧菜单 → 「数据库」→ 点击 articles 集合
   ```

4. **修改权限**
   ```
   点击上方「权限设置」按钮（或「设置」→「权限设置」）
   ```

5. **选择权限模式**
   
   **如果看到预设选项：**
   ```
   选择：☑ 所有用户可读，仅创建者可写
   ```
   
   **如果需要自定义规则：**
   ```
   选择：自定义安全规则
   
   输入规则：
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```

6. **保存**
   ```
   点击「保存」或「确定」
   ```

#### 方法 B：微信开发者工具

1. **打开云开发控制台**
   ```
   微信开发者工具 → 顶部「云开发」→ 数据库
   ```

2. **选择 articles 集合**

3. **点击「权限设置」**

4. **选择权限模式**
   ```
   所有用户可读，仅创建者可写
   ```
   
   或输入自定义规则：
   ```json
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```

5. **保存**

---

### Step 2: 检查文章数据

1. **确认文章已创建**
   ```
   CMS 后台 → 内容管理 → 文章
   应该能看到你创建的文章
   ```

2. **确认状态为 published**
   ```
   打开文章编辑页
   检查 status 字段 = "published"
   如果不是，改为 "published" 并保存
   ```

3. **确认字段完整**
   ```
   必须有的字段：
   - title（标题）
   - content（正文）
   - status（状态 = published）
   - timestamp（时间戳）
   
   如果缺少任何字段，补充完整
   ```

---

### Step 3: 测试小程序

1. **重新编译**
   ```
   微信开发者工具 → 点击「编译」按钮
   ```

2. **清除缓存**
   ```
   微信开发者工具 → 工具 → 清缓存 → 清除数据缓存
   ```

3. **进入首页**
   ```
   等待加载...
   ```

4. **查看控制台日志**
   
   **成功的日志：**
   ```
   从云数据库加载到文章：1  ✅
   文章加载成功 ✅
   ```
   
   **失败的日志：**
   ```
   云数据库暂无文章，使用本地备份  ❌
   ```

5. **如果仍然失败，下拉刷新**
   ```
   在首页下拉
   触发刷新
   ```

---

## 🎯 验证成功的标志

### 首页

- ✅ 能看到你在 CMS 中创建的文章标题
- ✅ 标签和分类正确显示
- ✅ 浏览量显示（可能是 0）

### 点击文章

- ✅ 能进入详情页
- ✅ 富文本内容正确显示
- ✅ 没有报错

---

## 🔍 如果还是不行

### 检查清单

#### 1. 环境 ID 是否正确

打开 `app.js`，检查：
```javascript
wx.cloud.init({
  env: 'cloud1-9g3v8lt8fb0108e7',  // ← 这个环境ID对吗？
  traceUser: true,
});
```

#### 2. 数据库集合名称

打开云开发控制台 → 数据库，确认：
```
集合名称必须是：articles  ✅
不能是：article、Article、ARTICLES  ❌
```

#### 3. CMS 内容模型标识

打开 CMS → 内容模型，确认：
```
标识（ID）必须是：articles  ✅
```

#### 4. 文章字段名称

在 CMS 中创建文章时，字段名称（标识）必须匹配：
```
title      ✅
content    ✅
status     ✅
timestamp  ✅
category   ✅
tag        ✅
tagType    ✅
```

**区分大小写！**

#### 5. 查看完整错误日志

打开控制台，找到红色的错误信息，发给我帮你分析。

---

## 💡 常见错误和解决方案

### 错误 1: 查询时添加了 _openid

```
db.collection('articles').where({
  status: 'published',
  _openid: 'xxx'  // ❌ 不应该有这个
})
```

**原因：** 数据库权限设置不正确

**解决：** 按照 Step 1 修改权限

---

### 错误 2: document.get:fail cannot find document

```
Error: document.get:fail cannot find document with _id 1
```

**原因：** 文章 ID 不存在或类型不匹配

**解决：** 
1. 确认文章已创建
2. 权限设置正确
3. 从首页点击文章进入（不要直接访问详情页）

---

### 错误 3: 云数据库暂无文章

```
云数据库暂无文章，使用本地备份
```

**原因：** 
1. 权限问题（最常见）
2. 文章状态不是 published
3. 数据库集合名称不匹配

**解决：**
1. 修改权限
2. 检查文章 status 字段
3. 检查集合名称

---

## 🚀 预期效果

### 修改权限前

```
小程序首页：
  ↓ 查询数据库
  ↓ 添加 _openid 过滤
  ↓ 查不到数据
  ↓ 使用本地备份 ❌
```

### 修改权限后

```
小程序首页：
  ↓ 查询数据库
  ↓ 不添加 _openid 过滤
  ↓ 查到数据 ✅
  ↓ 显示文章列表 ✅
```

---

## 📱 操作录屏建议

如果还是不行，建议你：

1. **录屏操作过程**
   - CMS 中的文章列表
   - 文章详情（字段值）
   - 数据库权限设置
   - 小程序运行效果

2. **截图控制台日志**
   - 完整的错误信息
   - 查询语句

3. **发给我分析**

---

## ✅ 最终检查

完成上述步骤后：

- [ ] 数据库权限已修改为"所有用户可读"
- [ ] 文章状态为 "published"
- [ ] 集合名称是 "articles"
- [ ] 重新编译了小程序
- [ ] 清除了缓存
- [ ] 控制台没有红色错误
- [ ] 能看到 CMS 创建的文章

---

**核心：修改数据库权限是关键！** 🔑

**立即去修改，大概率就能解决！** 🚀
