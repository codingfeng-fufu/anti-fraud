# AI 图片识别功能部署指南

## 📋 部署步骤

### 步骤 1：打开微信开发者工具

1. 启动微信开发者工具
2. 打开你的小程序项目

---

### 步骤 2：部署云函数

#### 方法一：通过开发者工具界面部署（推荐）

1. **找到云函数目录**
   - 在左侧文件树中找到 `cloudfunctions` 文件夹
   - 展开后找到 `aiChat` 文件夹

2. **右键点击 aiChat 文件夹**
   - 选择 **"上传并部署：云端安装依赖"**
   - 这会自动安装 `axios` 等依赖包

3. **等待部署完成**
   - 控制台会显示部署进度
   - 看到 "上传成功" 提示即可

#### 方法二：通过命令行部署

```bash
# 进入云函数目录
cd cloudfunctions/aiChat

# 安装依赖
npm install

# 返回项目根目录
cd ../..

# 在开发者工具中右键 aiChat → 上传并部署
```

---

### 步骤 3：配置云函数超时时间

1. **打开云开发控制台**
   - 在微信开发者工具顶部菜单
   - 点击 **"云开发"** 按钮
   - 或者点击左侧的 **"云开发"** 图标

2. **进入云函数管理**
   - 在云开发控制台左侧菜单
   - 点击 **"云函数"**

3. **配置 aiChat 函数**
   - 找到 `aiChat` 云函数
   - 点击函数名称进入详情页
   - 点击 **"函数配置"** 标签
   - 修改 **"超时时间"** 为 **30 秒**（图片识别需要更长时间）
   - 点击 **"保存"**

---

### 步骤 4：配置云函数权限（重要）

由于使用了微信 OCR 接口，需要确保云函数有调用权限：

1. **在云开发控制台**
   - 点击左侧 **"设置"**
   - 选择 **"权限设置"**

2. **确认权限**
   - 确保云函数有 **"调用云开发 API"** 权限
   - 微信 OCR 是云开发自带功能，通常默认开启

---

### 步骤 5：测试功能

#### 测试文字对话

1. 在小程序中打开 AI 聊天页面
2. 输入文字消息，如："什么是刷单诈骗？"
3. 查看 AI 是否正常回复

#### 测试图片识别

1. 点击 📷 按钮
2. 选择一张包含文字的图片（如诈骗聊天截图）
3. 等待识别结果
4. AI 应该会分析图片中的文字内容

---

### 步骤 6：查看日志（调试用）

如果功能不正常，查看云函数日志：

1. **打开云开发控制台**
2. **点击左侧 "云函数"**
3. **找到 aiChat 函数**
4. **点击 "日志"** 标签
5. **查看最近的调用日志**

日志会显示：
- OCR 识别结果
- 提取的文字内容
- AI 分析过程
- 错误信息（如果有）

---

## 🔍 常见问题

### 问题 1：部署失败，提示 "依赖安装失败"

**解决方案：**
1. 检查 `cloudfunctions/aiChat/package.json` 是否存在
2. 确保文件内容正确：
```json
{
  "name": "aiChat",
  "version": "1.0.0",
  "dependencies": {
    "wx-server-sdk": "latest",
    "axios": "^1.6.0"
  }
}
```
3. 重新右键 → "上传并部署：云端安装依赖"

---

### 问题 2：图片识别失败，提示 "OCR 识别失败"

**可能原因：**
- 图片中没有文字
- 图片不清晰
- 图片格式不支持

**解决方案：**
1. 确保图片清晰
2. 图片中要有明显的文字
3. 支持的格式：JPG、PNG

---

### 问题 3：AI 回复 "服务暂时不可用"

**可能原因：**
- API Key 无效
- 网络问题
- 超出免费额度

**解决方案：**
1. 检查 `QWEN_API_KEY` 是否正确
2. 登录阿里云控制台查看 API 调用情况
3. 查看云函数日志获取详细错误信息

---

### 问题 4：图片识别很慢

**原因：**
- OCR 识别需要时间
- AI 分析需要时间

**优化方案：**
- 已设置 30 秒超时
- 前端显示 "正在识别图片..." 加载提示
- 用户体验已优化

---

## 📊 功能验证清单

部署完成后，请逐项验证：

- [ ] 文字对话功能正常
- [ ] 可以上传图片
- [ ] OCR 能识别图片中的文字
- [ ] AI 能分析文字内容
- [ ] 返回诈骗风险评估
- [ ] 错误提示友好

---

## 💰 费用说明

### 当前方案费用：完全免费

1. **微信 OCR**：免费
2. **通义千问 qwen-turbo**：
   - 每天有免费额度
   - 超出后按 Token 计费（约 ¥0.0008/千 Token）
   - 正常使用基本在免费额度内

### 预估费用

假设每天 100 次图片识别：
- OCR：免费
- AI 分析：约 100 次 × 500 Token = 50,000 Token
- 费用：50 × ¥0.0008 = ¥0.04/天

**结论**：基本免费，即使超出也非常便宜。

---

## 🎯 部署完成后

恭喜！AI 图片识别功能已经部署完成。

### 功能说明

用户上传诈骗截图后：
1. 系统自动提取图片中的文字（OCR）
2. AI 分析文字内容
3. 识别诈骗特征
4. 给出风险评估（高/中/低风险）
5. 提供防范建议

### 适用场景

- ✅ 刷单兼职聊天截图
- ✅ 投资理财广告图片
- ✅ 网购退款诈骗对话
- ✅ 杀猪盘聊天记录
- ✅ 任何包含文字的诈骗信息

### 限制

- ⚠️ 只能识别文字内容
- ⚠️ 无法理解图片布局、颜色等视觉信息
- ⚠️ 图片必须清晰，文字可读

---

## 📞 技术支持

如有问题，请查看：
1. 云函数日志
2. 微信开发者工具控制台
3. 阿里云 DashScope 控制台

---

**部署时间**：约 5-10 分钟  
**难度**：⭐⭐☆☆☆（简单）  
**费用**：💰 免费
